{% extends "base.html" %}
{% load evewire %}

{% block title %}{{ plan.name }} - Skill Plans - evewire{% endblock %}

{% block extra_head %}
<style>
/* 3-column skill plan layout */
.skill-plan-grid {
    display: grid;
    grid-template-columns: 300px 1fr 300px;
    gap: 1rem;
    align-items: start;
}

.skill-list-item {
    padding: 0.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.skill-list-item .skill-name {
    font-weight: 500;
}

.skill-list-item .skill-level {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-left: 0.5rem;
}

.skill-list-item .remove-btn {
    background: none;
    border: none;
    color: #c00;
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0 0.5rem;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.skill-list-item .remove-btn:hover {
    opacity: 1;
}

.pilot-row {
    padding: 0.5rem;
    border-bottom: 1px solid var(--table-border);
}

.pilot-row .pilot-name {
    font-weight: 500;
}

.pilot-row .pilot-sp {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.progress-mini {
    width: 100px;
    height: 6px;
    background: var(--border-color);
    border-radius: 3px;
    overflow: hidden;
}

.progress-mini-fill {
    height: 100%;
    transition: width 0.3s ease;
}

@media (max-width: 1200px) {
    .skill-plan-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h1>{{ plan.name }}</h1>
    <div>
        <a href="{% url 'core:skill_plan_export' plan.id %}?prereqs=1&known=0" class="btn" style="margin-right: 0.5rem;">Export</a>
        <a href="{% url 'core:skill_plan_list' %}">Back to Plans</a>
    </div>
</div>

{% if plan.description %}
<div class="card" style="margin-bottom: 1rem;">
    <p>{{ plan.description }}</p>
</div>
{% endif %}

<!-- 3-column layout -->
<div class="skill-plan-grid">
    <!-- Left column: Pilot progress (always shown) -->
    <div class="card">
        <h2>Pilots ({{ total_pilots }})</h2>
        {% if pilot_progress %}
            {% for pilot in pilot_progress %}
            <div class="pilot-row">
                <div class="pilot-name">
                    <a href="{% url 'core:character_overview' pilot.character.id %}" style="text-decoration: none; color: inherit;">
                        {{ pilot.character.character_name }}
                    </a>
                </div>
                <div class="pilot-sp" style="margin-top: 0.25rem;">
                    {{ pilot.progress.current_sp|commas }} / {{ pilot.progress.total_sp|commas }} SP
                </div>
                <div style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <div class="progress-mini">
                        <div class="progress-mini-fill" style="width: {{ pilot.percent_complete }}%; background: {% if pilot.percent_complete == 100 %}#080{% elif pilot.percent_complete >= 50 %}#cc0{% else %}#c00{% endif %};"></div>
                    </div>
                    <span style="font-size: 0.85rem; color: var(--text-secondary);">{{ pilot.percent_complete|floatformat:0 }}%</span>
                </div>
                {% if pilot.percent_complete < 100 and pilot.total_training_seconds %}
                <div style="margin-top: 0.25rem; font-size: 0.8rem; color: var(--text-secondary);">
                    {{ pilot.total_training_seconds|format_duration }} remaining
                </div>
                {% elif pilot.percent_complete == 100 %}
                <div style="margin-top: 0.25rem; font-size: 0.8rem; color: #080;">
                    âœ“ Complete
                </div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <p style="color: #666; font-size: 0.9rem;">No characters found. Add characters to see progress.</p>
        {% endif %}
    </div>

    <!-- Middle column: Skill list -->
    <div class="card">
        <h2>Skills ({{ entries|length }})</h2>
        {% if entries %}
            <ul style="list-style: none; padding: 0; margin: 0;">
                {% for entry in entries %}
                <li class="skill-list-item">
                    <span>
                        <span class="skill-name">{{ entry.skill_name }}</span>
                        {% if entry.level %}
                        <span class="skill-level">{{ entry.level_roman }}</span>
                        {% endif %}
                    </span>
                    <form method="post" action="{% url 'core:skill_plan_remove_skill' plan.id entry.id %}" style="display: inline;" onsubmit="return confirm('Remove {{ entry.skill_name }} {{ entry.level_roman }} from plan?');">
                        {% csrf_token %}
                        <button type="submit" class="remove-btn" title="Remove from plan">ðŸ—‘</button>
                    </form>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p style="color: #666;">No skills in this plan yet.</p>
        {% endif %}
    </div>

    <!-- Right column: Quick Add -->
    <div class="card">
        <h2>Quick Add</h2>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
            Paste skills from clipboard:
        </p>
        <form method="post" action="{% url 'core:skill_plan_import_skills' plan.id %}">
            {% csrf_token %}
            <textarea name="skills" rows="15" style="width: 100%; padding: 0.5rem; font-family: monospace; font-size: 0.9rem;" placeholder="Amarr Destroyer 1
Amarr Battleship V
Gallente Cruiser 3
..."></textarea>
            <p style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">
                <strong>Format:</strong> One skill per line: <code>SKILL_NAME LEVEL</code><br>
                Level can be 1-5 or I-V.<br>
                Example: <code>Amarr Battleship V</code> or <code>Amarr Battleship 5</code>
            </p>
            <button type="submit" class="btn">Add Skills</button>
        </form>
    </div>
</div>
{% endblock %}
