{% extends "base.html" %}
{% load evewire %}

{% block title %}Trade Analysis - {{ character.name }} - evewire{% endblock %}

{% block content %}
<h1>Trade Analysis - {{ character.name }}</h1>

<div style="margin-bottom: 1rem;">
    <a href="{% url 'core:dashboard' %}">Dashboard</a>
    <span style="margin: 0 0.5rem;">&rarr;</span>
    <a href="{% url 'core:trade_overview' %}">Trade Analysis</a>
</div>

<div class="card">
    <h2>Timeframe Filter</h2>
    <form method="get" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
        <div>
            <label for="timeframe" style="display: block; margin-bottom: 0.25rem;">Quick Select:</label>
            <select name="timeframe" id="timeframe" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color);">
                <option value="all" {% if timeframe == 'all' %}selected{% endif %}>All Time</option>
                <option value="30d" {% if timeframe == '30d' %}selected{% endif %}>Last 30 Days</option>
                <option value="90d" {% if timeframe == '90d' %}selected{% endif %}>Last 90 Days</option>
                <option value="12m" {% if timeframe == '12m' %}selected{% endif %}>Last 12 Months</option>
            </select>
        </div>
        {% if campaigns %}
        <div>
            <label for="campaign" style="display: block; margin-bottom: 0.25rem;">Campaign:</label>
            <select name="campaign" id="campaign" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color);">
                <option value="">None</option>
                {% for campaign in campaigns %}
                <option value="{{ campaign.id }}" {% if campaign_id|stringformat:"s" == campaign.id|stringformat:"s" %}selected{% endif %}>{{ campaign.title }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        <button type="submit" class="btn">Apply</button>
        <a href="{% url 'core:trade_overview' %}" class="btn" style="background: var(--text-secondary);">Clear</a>
    </form>
    <p style="margin-top: 0.5rem; color: var(--text-secondary);">Current: {{ timeframe_label }}</p>
</div>

<div class="card">
    <h2>Overview Statistics</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div style="padding: 1rem; background: var(--card-bg); border-radius: 8px; border-left: 4px solid var(--accent-primary);">
            <div style="font-size: 0.9rem; color: var(--text-secondary);">Total Buy Volume</div>
            <div style="font-size: 1.5rem; font-weight: bold; color: var(--alert-error-text);">{{ total_buy|format_is }} ISK</div>
        </div>
        <div style="padding: 1rem; background: var(--card-bg); border-radius: 8px; border-left: 4px solid var(--accent-primary);">
            <div style="font-size: 0.9rem; color: var(--text-secondary);">Total Sell Volume</div>
            <div style="font-size: 1.5rem; font-weight: bold; color: var(--alert-success-text);">{{ total_sell|format_is }} ISK</div>
        </div>
        <div style="padding: 1rem; background: var(--card-bg); border-radius: 8px; border-left: 4px solid var(--accent-primary);">
            <div style="font-size: 0.9rem; color: var(--text-secondary);">Net Balance</div>
            <div style="font-size: 1.5rem; font-weight: bold; color: {% if net_balance >= 0 %}var(--alert-success-text){% else %}var(--alert-error-text){% endif %};">
                {% if net_balance >= 0 %}+{% endif %}{{ net_balance|format_is }} ISK
            </div>
        </div>
    </div>
</div>

{% if monthly_summaries %}
<div class="card">
    <h2>Monthly History</h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid var(--border-color);">
                <th style="padding: 0.75rem; text-align: left;">Month</th>
                <th style="padding: 0.75rem; text-align: right;">Buy Volume</th>
                <th style="padding: 0.75rem; text-align: right;">Sell Volume</th>
                <th style="padding: 0.75rem; text-align: right;">Net Balance</th>
                <th style="padding: 0.75rem; text-align: center;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for year, month, items in monthly_summaries %}
            {% if items %}
            {% regroup items by type_id as type_groups %}
            {% for group in type_groups %}
            {% if forloop.first %}
            {% with buy_total=0 sell_total=0 %}
            {% for item in items %}
            {% with buy_total=buy_total|add:item.buy_total sell_total=sell_total|add:item.sell_total %}
            {% if forloop.last %}
            <tr style="border-bottom: 1px solid var(--table-border);">
                <td style="padding: 0.75rem;">{{ year }}-{{ month|stringformat:"02d" }}</td>
                <td style="padding: 0.75rem; text-align: right; color: var(--alert-error-text);">{{ buy_total|format_is }} ISK</td>
                <td style="padding: 0.75rem; text-align: right; color: var(--alert-success-text);">{{ sell_total|format_is }} ISK</td>
                <td style="padding: 0.75rem; text-align: right; font-weight: bold; color: {% if sell_total >= buy_total %}var(--alert-success-text){% else %}var(--alert-error-text){% endif %};">
                    {% if sell_total >= buy_total %}+{% endif %}{{ sell_total|add:buy_total|format_is }} ISK
                </td>
                <td style="padding: 0.75rem; text-align: center;">
                    <a href="?year={{ year }}&month={{ month }}" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.9rem;">View</a>
                </td>
            </tr>
            {% endif %}
            {% endwith %}
            {% endfor %}
            {% endwith %}
            {% endif %}
            {% endfor %}
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if top_profitable %}
<div class="card">
    <h2>Top 10 Profitable Items</h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid var(--border-color);">
                <th style="padding: 0.75rem; text-align: left;">Item</th>
                <th style="padding: 0.75rem; text-align: right;">Buy Total</th>
                <th style="padding: 0.75rem; text-align: right;">Sell Total</th>
                <th style="padding: 0.75rem; text-align: right;">Balance</th>
                <th style="padding: 0.75rem; text-align: right;">Margin</th>
                <th style="padding: 0.75rem; text-align: center;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in top_profitable %}
            <tr style="border-bottom: 1px solid var(--table-border);">
                <td style="padding: 0.75rem; font-weight: bold;">{{ item.type_name }}</td>
                <td style="padding: 0.75rem; text-align: right; color: var(--alert-error-text);">{{ item.buy_total|format_is }} ISK</td>
                <td style="padding: 0.75rem; text-align: right; color: var(--alert-success-text);">{{ item.sell_total|format_is }} ISK</td>
                <td style="padding: 0.75rem; text-align: right; font-weight: bold; color: var(--alert-success-text);">
                    +{{ item.balance|format_is }} ISK
                </td>
                <td style="padding: 0.75rem; text-align: right;">{{ item.profit_pct|floatformat:1 }}%</td>
                <td style="padding: 0.75rem; text-align: center;">
                    <a href="{% url 'core:trade_item_detail' character.id item.type_id %}?timeframe={{ timeframe }}{% if campaign_id %}&campaign={{ campaign_id }}{% endif %}" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.9rem;">Details</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if top_losses %}
<div class="card">
    <h2>Top 10 Loss-Making Items</h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid var(--border-color);">
                <th style="padding: 0.75rem; text-align: left;">Item</th>
                <th style="padding: 0.75rem; text-align: right;">Buy Total</th>
                <th style="padding: 0.75rem; text-align: right;">Sell Total</th>
                <th style="padding: 0.75rem; text-align: right;">Balance</th>
                <th style="padding: 0.75rem; text-align: right;">Margin</th>
                <th style="padding: 0.75rem; text-align: center;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in top_losses %}
            <tr style="border-bottom: 1px solid var(--table-border);">
                <td style="padding: 0.75rem; font-weight: bold;">{{ item.type_name }}</td>
                <td style="padding: 0.75rem; text-align: right; color: var(--alert-error-text);">{{ item.buy_total|format_is }} ISK</td>
                <td style="padding: 0.75rem; text-align: right; color: var(--alert-success-text);">{{ item.sell_total|format_is }} ISK</td>
                <td style="padding: 0.75rem; text-align: right; font-weight: bold; color: var(--alert-error-text);">
                    {{ item.balance|format_is }} ISK
                </td>
                <td style="padding: 0.75rem; text-align: right;">{{ item.profit_pct|floatformat:1 }}%</td>
                <td style="padding: 0.75rem; text-align: center;">
                    <a href="{% url 'core:trade_item_detail' character.id item.type_id %}?timeframe={{ timeframe }}{% if campaign_id %}&campaign={{ campaign_id }}{% endif %}" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.9rem;">Details</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if top_volume %}
<div class="card">
    <h2>Top 10 Items by Volume</h2>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid var(--border-color);">
                <th style="padding: 0.75rem; text-align: left;">Item</th>
                <th style="padding: 0.75rem; text-align: right;">Total Volume</th>
                <th style="padding: 0.75rem; text-align: right;">Buy Qty</th>
                <th style="padding: 0.75rem; text-align: right;">Sell Qty</th>
                <th style="padding: 0.75rem; text-align: right;">Balance</th>
                <th style="padding: 0.75rem; text-align: center;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in top_volume %}
            {% with total_volume=item.buy_total|add:item.sell_total %}
            <tr style="border-bottom: 1px solid var(--table-border);">
                <td style="padding: 0.75rem; font-weight: bold;">{{ item.type_name }}</td>
                <td style="padding: 0.75rem; text-align: right;">{{ total_volume|format_is }} ISK</td>
                <td style="padding: 0.75rem; text-align: right;">{{ item.buy_quantity }}</td>
                <td style="padding: 0.75rem; text-align: right;">{{ item.sell_quantity }}</td>
                <td style="padding: 0.75rem; text-align: right; font-weight: bold; color: {% if item.balance >= 0 %}var(--alert-success-text){% else %}var(--alert-error-text){% endif %};">
                    {% if item.balance >= 0 %}+{% endif %}{{ item.balance|format_is }} ISK
                </td>
                <td style="padding: 0.75rem; text-align: center;">
                    <a href="{% url 'core:trade_item_detail' character.id item.type_id %}?timeframe={{ timeframe }}{% if campaign_id %}&campaign={{ campaign_id }}{% endif %}" class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.9rem;">Details</a>
                </td>
            </tr>
            {% endwith %}
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if not summaries %}
<div class="card">
    <p>No transactions found for the selected timeframe.</p>
</div>
{% endif %}

{% endblock %}
