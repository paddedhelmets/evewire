{% extends "base.html" %}
{% load evewire %}

{% block title %}{% if character %}Assets - {{ character.name }}{% else %}Assets - All Characters{% endif %}{% endblock %}

{% block extra_head %}
<style>
    .assets-container {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
    }

    .assets-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .assets-stats {
        display: flex;
        gap: 2rem;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .assets-controls button {
        background: var(--btn-primary);
        color: white;
        border: none;
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        margin-left: 0.5rem;
    }

    .assets-controls button:hover {
        background: var(--btn-primary-hover);
    }

    .pilot-filter-bar {
        background: var(--bg-primary);
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
    }

    .pilot-filter-bar summary {
        cursor: pointer;
        font-weight: 600;
        padding: 0.5rem;
        user-select: none;
    }

    .pilot-filter-content {
        margin-top: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
    }

    .pilot-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: var(--bg-secondary);
        border-radius: 4px;
        border: 1px solid var(--border-color);
    }

    .pilot-checkbox input {
        margin: 0;
    }

    /* Search box */
    .search-bar {
        background: var(--bg-primary);
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
    }

    .search-input-wrapper {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .search-input-wrapper input {
        flex: 1;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .search-input-wrapper button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .search-input-wrapper button.search-btn {
        background: var(--btn-primary);
        color: white;
    }

    .search-input-wrapper button.clear-btn {
        background: var(--text-secondary);
        color: white;
    }

    /* Location tree */
    .location-tree {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .location-node {
        background: var(--bg-primary);
        border-radius: 4px;
        border: 1px solid var(--border-color);
    }

    .location-header {
        padding: 0.75rem 1rem;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: background 0.2s;
    }

    .location-header:hover {
        background: var(--bg-secondary);
    }

    .location-expand {
        width: 16px;
        height: 16px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        transition: transform 0.2s;
    }

    .location-expand.expanded {
        transform: rotate(90deg);
    }

    .location-name {
        font-weight: 600;
        flex: 1;
    }

    .location-badge {
        font-size: 0.75rem;
        padding: 0.1rem 0.4rem;
        border-radius: 3px;
        background: #e2e3e5;
        color: #383d41;
    }

    [data-theme="dark"] .location-badge {
        background: #2d2d2d;
        color: #a0a0a0;
    }

    /* Assets table */
    .asset-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        display: none;
    }

    .asset-table.visible {
        display: table;
    }

    .asset-table th {
        background: var(--bg-secondary);
        padding: 0.6rem 0.8rem;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid var(--border-color);
        color: var(--text-secondary);
    }

    .asset-table td {
        padding: 0.5rem 0.8rem;
        border-bottom: 1px solid var(--table-border);
    }

    .asset-table tr:hover {
        background: var(--bg-secondary);
    }

    .asset-item-name {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .asset-expand {
        cursor: pointer;
        user-select: none;
        width: 16px;
        height: 16px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        transition: transform 0.2s;
    }

    .asset-expand.expanded {
        transform: rotate(90deg);
    }

    .asset-expand:hover {
        color: var(--link-color);
    }

    .asset-indent {
        padding-left: 1.5rem;
    }

    .blueprint-badge {
        font-size: 0.7rem;
        padding: 0.1rem 0.4rem;
        border-radius: 3px;
        margin-left: 0.5rem;
    }

    .blueprint-bpo {
        background: #d4edda;
        color: #155724;
    }

    .blueprint-bpc {
        background: #fff3cd;
        color: #856404;
    }

    [data-theme="dark"] .blueprint-bpo {
        background: #1e4a2a;
        color: #6bff6b;
    }

    [data-theme="dark"] .blueprint-bpc {
        background: #4a3d1a;
        color: #ffc107;
    }

    .singleton-badge {
        font-size: 0.7rem;
        padding: 0.1rem 0.4rem;
        border-radius: 3px;
        background: #cce5ff;
        color: #004085;
    }

    [data-theme="dark"] .singleton-badge {
        background: #1a3a5c;
        color: #66b3ff;
    }

    .child-count-badge {
        font-size: 0.7rem;
        padding: 0.1rem 0.4rem;
        border-radius: 3px;
        background: #e2e3e5;
        color: #383d41;
        margin-left: 0.25rem;
    }

    [data-theme="dark"] .child-count-badge {
        background: #2d2d2d;
        color: #a0a0a0;
    }

    .loading-spinner {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid var(--border-color);
        border-top-color: var(--link-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .location-type {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--text-secondary);
    }

    .no-assets {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="assets-container">
    <div class="assets-header">
        <div>
            <h2>Assets</h2>
            <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                {% if character %}
                    Character: <strong>{{ character.name }}</strong>
                {% else %}
                    <strong>All Characters</strong>
                {% endif %}
            </p>
        </div>
        <div class="assets-stats">
            <span>Locations: <strong>{{ total_locations }}</strong></span>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <a href="{% url 'core:assets_list' %}" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">List</a>
            <a href="{% url 'core:assets_summary' %}" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">Summary</a>
            <a href="{% url 'core:fitted_ships' %}" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">Fitted Ships</a>
            <a href="{% url 'core:assets_export' %}" class="btn" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: #28a745;">Export CSV</a>
        </div>
    </div>

    {% if is_account_wide %}
    <!-- Pilot Filter (account-wide view) -->
    <div class="pilot-filter-bar">
        <details{% if pilot_filter %} open{% endif %}>
            <summary>
                Filter by Pilot
                {% if pilot_filter %}
                    <span style="font-weight: normal; color: var(--text-secondary); margin-left: 0.5rem;">
                        ({{ pilot_filter|length }} selected)
                    </span>
                {% endif %}
            </summary>
            <form method="get" class="pilot-filter-content">
                {% for char in all_characters %}
                <label class="pilot-checkbox">
                    <input type="checkbox" name="pilots" value="{{ char.id }}" {% if char.id in pilot_filter %}checked{% endif %}>
                    {{ char.character_name }}
                </label>
                {% endfor %}
                <button type="submit" class="btn">Apply</button>
                {% if pilot_filter %}
                <a href="{% url 'core:assets_list' %}" class="btn" style="background: var(--text-secondary);">Clear</a>
                {% endif %}
            </form>
        </details>
    </div>
    {% endif %}

    <!-- Search and Location Filter -->
    <div class="search-bar">
        <form method="get" class="search-input-wrapper">
            {% for pid in pilot_filter %}
            <input type="hidden" name="pilots" value="{{ pid }}">
            {% endfor %}
            <input type="text" name="search" placeholder="Search item names..." value="{{ search_query }}" id="search-input">
            <button type="submit" class="search-btn">Search</button>
            {% if search_query or location_filter %}
            <a href="{% url 'core:assets_list' %}" class="btn clear-btn">Clear All</a>
            {% endif %}
        </form>
    </div>

    <!-- Location Filter -->
    <div style="background: var(--bg-primary); padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
        <form method="get" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            {% for pid in pilot_filter %}
            <input type="hidden" name="pilots" value="{{ pid }}">
            {% endfor %}
            {% if search_query %}
            <input type="hidden" name="search" value="{{ search_query }}">
            {% endif %}
            <div>
                <label for="location" style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem;">Filter by Location:</label>
                <select name="location" id="location" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); min-width: 300px;">
                    <option value="">All Locations</option>
                    {% for loc in available_locations %}
                    <option value="{{ loc.id }}" {% if location_filter == loc.id|stringformat:"s" %}selected{% endif %}>
                        {{ loc.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn">Apply Filter</button>
        </form>
    </div>

    <!-- Location Tree -->
    {% if locations %}
        <div class="location-tree" id="location-tree">
            {% for location in locations %}
            <div class="location-node" data-location-id="{{ location.location_id }}" data-location-type="{{ location.location_type }}">
                <div class="location-header" onclick="toggleLocation({{ location.location_id }}, '{{ location.location_type }}', this)">
                    <span class="location-expand">&#9654;</span>
                    <span class="location-name">{{ location.location_name }}</span>
                    <span class="location-badge">{{ location.asset_count }} items</span>
                    <span class="location-type">{{ location.location_type }}</span>
                </div>
                <table class="asset-table" id="assets-table-{{ location.location_id }}-{{ location.location_type }}">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Item</th>
                            {% if is_account_wide %}
                            <th style="width: 10%;">Pilot</th>
                            {% endif %}
                            <th style="width: 10%;">Flag</th>
                            <th style="width: 10%; text-align: right;">Quantity</th>
                            <th style="width: 15%;">Singleton</th>
                        </tr>
                    </thead>
                    <tbody id="assets-tbody-{{ location.location_id }}-{{ location.location_type }}">
                        <!-- Assets loaded via AJAX -->
                    </tbody>
                </table>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="no-assets">
            <p>No assets found for this character.</p>
            <p>Assets may not have been synced yet.</p>
        </div>
    {% endif %}
</div>

<script>
// Track loaded locations and assets
const loadedLocations = new Set();
const loadedChildren = new Set();

/**
 * Toggle location expansion and load assets if needed
 */
async function toggleLocation(locationId, locationType, headerElement) {
    const expandIcon = headerElement.querySelector('.location-expand');
    const table = document.getElementById(`assets-table-${locationId}-${locationType}`);
    const isExpanded = expandIcon.classList.contains('expanded');
    const locationKey = `${locationId}-${locationType}`;

    if (isExpanded) {
        // Collapse
        expandIcon.classList.remove('expanded');
        expandIcon.innerHTML = '&#9654;';
        table.classList.remove('visible');
        return;
    }

    // Expand
    if (loadedLocations.has(locationKey)) {
        // Already loaded, just show
        expandIcon.classList.add('expanded');
        expandIcon.innerHTML = '&#9660;';
        table.classList.add('visible');
        return;
    }

    // Show loading state
    expandIcon.innerHTML = '<span class="loading-spinner"></span>';

    try {
        // Build URL with filters
        let url = `/api/assets/location/${locationId}/${locationType}/`;
        const params = new URLSearchParams();

        // Add pilot filter from URL
        const urlParams = new URLSearchParams(window.location.search);
        const pilots = urlParams.getAll('pilots');
        if (pilots.length > 0) {
            pilots.forEach(p => params.append('pilot_filter', p));
        }

        // Add search filter
        const search = urlParams.get('search');
        if (search) {
            params.append('search', search);
        }

        if (params.toString()) {
            url += '?' + params.toString();
        }

        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || 'Failed to load assets');
        }

        // Render assets
        const tbody = document.getElementById(`assets-tbody-${locationId}-${locationType}`);
        if (data.assets.length > 0) {
            tbody.innerHTML = renderAssetRows(data.assets);
        } else {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 2rem;">No assets at this location</td></tr>';
        }

        // Mark as loaded and show
        loadedLocations.add(locationKey);
        expandIcon.classList.add('expanded');
        expandIcon.innerHTML = '&#9660;';
        table.classList.add('visible');

    } catch (error) {
        console.error('Failed to load location assets:', error);
        expandIcon.innerHTML = '&#9654;';
        alert('Failed to load assets: ' + error.message);
    }
}

/**
 * Render asset rows from API data
 */
function renderAssetRows(assets) {
    const isAccountWide = {{ is_account_wide|yesno }};

    return assets.map(asset => {
        const hasChildren = asset.has_children;
        const expandIcon = hasChildren
            ? `<span class="asset-expand" data-asset-id="${asset.item_id}" onclick="lazyLoadChildren(event, this)">&#9654;</span>`
            : '<span style="width: 16px; display: inline-block;"></span>';
        const childCountBadge = hasChildren ? `<span class="child-count-badge">(${asset.child_count})</span>` : '';
        const pilotColumn = isAccountWide ? `
            <td>
                <a href="/characters/${asset.character_id}/" style="font-size: 0.85rem; color: var(--link-color);">
                    ${asset.character_name}
                </a>
            </td>
        ` : '';
        const singletonIndicator = asset.is_singleton
            ? '<span style="color: #0066cc;">&#10003;</span>'
            : '<span style="color: var(--text-secondary);">&mdash;</span>';
        const blueprintBadge = asset.is_blueprint_copy
            ? '<span class="blueprint-badge blueprint-bpc">BPC</span>' : '';
        const singletonBadge = asset.is_singleton
            ? '<span class="singleton-badge">Assembled</span>' : '';

        return `
            <tr class="asset-row"
                data-asset-id="${asset.item_id}"
                data-has-children="${hasChildren}"
                data-child-count="${asset.child_count}"
                data-children-loaded="false">
                <td>
                    <div class="asset-item-name">
                        ${expandIcon}
                        ${childCountBadge}
                        <span class="asset-name">${asset.type_name}</span>
                        ${blueprintBadge}
                        ${singletonBadge}
                    </div>
                </td>
                ${pilotColumn}
                <td style="color: var(--text-secondary); font-size: 0.85rem;">${asset.location_flag || '&mdash;'}</td>
                <td style="text-align: right;">${asset.quantity}</td>
                <td>${singletonIndicator}</td>
            </tr>
            <tbody class="asset-children-container" id="asset-children-${asset.item_id}" style="display: none;"></tbody>
        `;
    }).join('');
}

/**
 * Lazy-load children via AJAX when expanding a container
 */
async function lazyLoadChildren(event, button) {
    event.stopPropagation();

    const assetId = button.getAttribute('data-asset-id');
    const childrenContainer = document.getElementById(`asset-children-${assetId}`);
    const isExpanded = button.classList.contains('expanded');

    if (isExpanded) {
        // Collapse
        button.classList.remove('expanded');
        button.innerHTML = '&#9654;';
        childrenContainer.style.display = 'none';
        return;
    }

    // Already loaded?
    if (loadedChildren.has(assetId)) {
        button.classList.add('expanded');
        button.innerHTML = '&#9660;';
        childrenContainer.style.display = 'table-row-group';
        return;
    }

    // Show loading
    button.innerHTML = '<span class="loading-spinner"></span>';

    try {
        let url = `/api/assets/${assetId}/children/`;
        const params = new URLSearchParams();

        const urlParams = new URLSearchParams(window.location.search);
        const pilots = urlParams.getAll('pilots');
        if (pilots.length > 0) {
            pilots.forEach(p => params.append('pilot_filter', p));
        }

        if (params.toString()) {
            url += '?' + params.toString();
        }

        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || 'Failed to load children');
        }

        if (data.children.length > 0) {
            childrenContainer.innerHTML = renderChildRows(data.children);
            childrenContainer.style.display = 'table-row-group';
            loadedChildren.add(assetId);
            button.classList.add('expanded');
            button.innerHTML = '&#9660;';
        } else {
            button.innerHTML = '&#9654;';
            loadedChildren.add(assetId);
        }

    } catch (error) {
        console.error('Failed to load children:', error);
        button.innerHTML = '&#9654;';
        alert('Failed to load children: ' + error.message);
    }
}

/**
 * Render child asset rows from API data
 */
function renderChildRows(children) {
    return children.map(child => {
        const hasChildren = child.has_children;
        const expandIcon = hasChildren
            ? `<span class="asset-expand" data-asset-id="${child.item_id}" onclick="lazyLoadChildren(event, this)">&#9654;</span>`
            : '<span style="width: 16px; display: inline-block;"></span>';
        const childCountBadge = hasChildren ? `<span class="child-count-badge">(${child.child_count})</span>` : '';
        const singletonIndicator = child.is_singleton
            ? '<span style="color: #0066cc;">&#10003;</span>'
            : '<span style="color: var(--text-secondary);">&mdash;</span>';
        const blueprintBadge = child.is_blueprint_copy
            ? '<span class="blueprint-badge blueprint-bpc">BPC</span>' : '';
        const singletonBadge = child.is_singleton
            ? '<span class="singleton-badge">Assembled</span>' : '';

        return `
            <tr class="asset-row"
                data-asset-id="${child.item_id}"
                data-has-children="${hasChildren}"
                data-child-count="${child.child_count}"
                data-children-loaded="false">
                <td>
                    <div class="asset-item-name asset-indent">
                        ${expandIcon}
                        ${childCountBadge}
                        <span class="asset-name">${child.type_name}</span>
                        ${blueprintBadge}
                        ${singletonBadge}
                    </div>
                </td>
                <td style="color: var(--text-secondary); font-size: 0.85rem;">${child.location_flag || '&mdash;'}</td>
                <td style="text-align: right;">${child.quantity}</td>
                <td>${singletonIndicator}</td>
            </tr>
            <tbody class="asset-children-container" id="asset-children-${child.item_id}" style="display: none;"></tbody>
        `;
    }).join('');
}
</script>
{% endblock %}
