{% extends "base.html" %}
{% load evewire %}

{% block title %}{{ plan.name }} - Skill Plans - evewire{% endblock %}

{% block extra_head %}
<style>
/* 3-column skill plan layout */
.skill-plan-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
    align-items: start;
}

.skill-list-item {
    padding: 0.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.skill-list-item.prerequisite {
    background: rgba(0, 100, 200, 0.05);
    opacity: 0.8;
}

.skill-list-item .skill-icon {
    margin-right: 0.5rem;
    font-size: 0.9rem;
}

.skill-list-item .skill-name {
    font-weight: 500;
}

.skill-list-item.prerequisite .skill-name {
    font-weight: 400;
    color: var(--text-secondary);
}

.skill-list-item .skill-level {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-left: 0.5rem;
}

.skill-list-item .remove-btn {
    background: none;
    border: none;
    color: #c00;
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0 0.5rem;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.skill-list-item .remove-btn:hover {
    opacity: 1;
}

.pilot-row {
    padding: 0.75rem 0.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
}

.pilot-row .pilot-left {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    flex: 1;
    min-width: 150px;
}

.pilot-row .pilot-name {
    font-weight: 500;
}

.pilot-row .pilot-time {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.pilot-row .pilot-right {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex: 1;
    justify-content: flex-end;
    min-width: 200px;
}

.pilot-row .pilot-sp {
    font-size: 0.85rem;
    color: var(--text-secondary);
    white-space: nowrap;
}

.progress-mini {
    width: 100px;
    height: 6px;
    background: var(--border-color);
    border-radius: 3px;
    overflow: hidden;
}

.progress-mini-fill {
    height: 100%;
    transition: width 0.3s ease;
    background: linear-gradient(90deg, #1976d2, #42a5f5);
}

.progress-mini-fill.prereq-fill {
    background: linear-gradient(90deg, #f57c00, #ffc107);
}
}

@media (max-width: 1200px) {
    .skill-plan-grid {
        grid-template-columns: 1fr;
    }
}

.toggle-prereqs {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    padding: 0.5rem;
    background: var(--bg-secondary);
    border-radius: 4px;
    font-size: 0.9rem;
}

.toggle-prereqs input {
    margin: 0;
}

.toggle-prereqs label {
    cursor: pointer;
    user-select: none;
}
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h1>{{ plan.name }}</h1>
    <div>
        <a href="{% url 'core:skill_plan_export' plan.id %}?prereqs=1&known=0" class="btn" style="margin-right: 0.5rem;">Export</a>
        <a href="{% url 'core:skill_plan_list' %}">Back to Plans</a>
    </div>
</div>

{% if plan.description %}
<div class="card" style="margin-bottom: 1rem;">
    <p>{{ plan.description }}</p>
</div>
{% endif %}

<!-- 3-column layout -->
<div class="skill-plan-grid">
    <!-- Left column: Pilot progress (always shown) -->
    <div class="card">
        <h2>Pilots ({{ total_pilots }})</h2>
        {% if pilot_progress %}
            {% for pilot in pilot_progress %}
            <div class="pilot-row">
                <div class="pilot-left">
                    <a href="{% url 'core:character_overview' pilot.character.id %}" style="text-decoration: none; color: inherit;">
                        <span class="pilot-name">{{ pilot.character.character_name }}</span>
                    </a>
                    {% if pilot.progress.primary_percent_complete < 100 and pilot.total_training_seconds %}
                    <span class="pilot-time">({{ pilot.total_training_seconds|format_duration }})</span>
                    {% elif pilot.progress.primary_percent_complete == 100 %}
                    <span class="pilot-time" style="color: #080;">‚úì</span>
                    {% endif %}
                </div>
                <div class="pilot-right">
                    <span class="pilot-sp">{{ pilot.progress.primary_sp_completed|commas }} / {{ pilot.progress.primary_sp_total|commas }} SP</span>
                    <div class="progress-mini">
                        <div class="progress-mini-fill" style="width: {{ pilot.progress.primary_percent_complete }}%; background: {% if pilot.progress.primary_percent_complete == 100 %}#080{% elif pilot.progress.primary_percent_complete >= 50 %}#cc0{% else %}#c00{% endif %};"></div>
                    </div>
                </div>
            </div>
            <!-- Prerequisite progress bar (only if incomplete) -->
            {% if not pilot.progress.prereq_complete %}
            <div class="pilot-row" style="background: rgba(0, 100, 200, 0.05);">
                <div class="pilot-left">
                    <span style="font-size: 0.85rem; color: #3a7ca5;">üì¶ Prerequisites</span>
                </div>
                <div class="pilot-right">
                    <span class="pilot-sp" style="font-size: 0.8rem;">{{ pilot.progress.prereq_sp_completed|commas }} / {{ pilot.progress.prereq_sp_total|commas }} SP</span>
                    <div class="progress-mini">
                        <div class="progress-mini-fill prereq-fill" style="width: {{ pilot.progress.prereq_percent_complete }}%;"></div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        {% else %}
            <p style="color: #666; font-size: 0.9rem;">No characters found. Add characters to see progress.</p>
        {% endif %}
    </div>

    <!-- Middle column: Skill list -->
    <div class="card">
        <h2>Skills ({{ entries|length }})</h2>
        <div class="toggle-prereqs">
            <input type="checkbox" id="hidePrereqs" onchange="togglePrerequisites()">
            <label for="hidePrereqs">Hide prerequisites (üì¶)</label>
        </div>
        {% if entries %}
            <ul id="skillList" style="list-style: none; padding: 0; margin: 0;">
                {% for entry in entries %}
                <li class="skill-list-item {% if entry.is_prerequisite %}prerequisite{% endif %}">
                    <span>
                        {% if entry.is_prerequisite %}
                        <span class="skill-icon">üì¶</span>
                        {% endif %}
                        <span class="skill-name">{{ entry.skill_name }}</span>
                        {% if entry.level %}
                        <span class="skill-level">{{ entry.level_roman }}</span>
                        {% endif %}
                    </span>
                    <div style="display: inline;">
                        {% if entry.is_prerequisite %}
                        <form method="post" action="{% url 'core:skill_plan_promote_prereq' plan.id entry.id %}" style="display: inline;" onsubmit="return confirm('Promote {{ entry.skill_name }} {{ entry.level_roman }} to a primary goal?');">
                            {% csrf_token %}
                            <button type="submit" class="remove-btn" style="color: #080;" title="Promote to primary goal">‚¨ÜÔ∏è</button>
                        </form>
                        {% endif %}
                        <form method="post" action="{% url 'core:skill_plan_remove_skill' plan.id entry.id %}" style="display: inline;" onsubmit="return confirm('Remove {{ entry.skill_name }} {{ entry.level_roman }} from plan?');">
                            {% csrf_token %}
                            <button type="submit" class="remove-btn" title="Remove from plan">üóë</button>
                        </form>
                    </div>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p style="color: #666;">No skills in this plan yet.</p>
        {% endif %}
    </div>

    <!-- Right column: Quick Add -->
    <div class="card">
        <h2>Quick Add</h2>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
            Paste skills from clipboard:
        </p>
        <form method="post" action="{% url 'core:skill_plan_import_skills' plan.id %}">
            {% csrf_token %}
            <textarea name="skills" rows="15" style="width: 100%; padding: 0.5rem; font-family: monospace; font-size: 0.9rem;" placeholder="Amarr Destroyer 1
Amarr Battleship V
Gallente Cruiser 3
..."></textarea>
            <p style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">
                <strong>Format:</strong> One skill per line: <code>SKILL_NAME LEVEL</code><br>
                Level can be 1-5 or I-V.<br>
                Example: <code>Amarr Battleship V</code> or <code>Amarr Battleship 5</code>
            </p>
            <button type="submit" class="btn">Add Skills</button>
        </form>
    </div>
</div>

<script>
function togglePrerequisites() {
    const hidePrereqs = document.getElementById('hidePrereqs').checked;
    const items = document.querySelectorAll('#skillList li.prerequisite');
    items.forEach(item => {
        item.style.display = hidePrereqs ? 'none' : 'flex';
    });
}
</script>
{% endblock %}
