{% extends "base.html" %}
{% load evewire %}

{% block title %}{{ plan.name }} - Skill Plans - evewire{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h1>{{ plan.name }}</h1>
    <div>
        <a href="{% url 'core:skill_plan_edit' plan.id %}" class="btn" style="margin-right: 0.5rem;">Edit Plan</a>
        <a href="{% url 'core:skill_plan_export' plan.id %}?prereqs=1&known=0" class="btn" style="margin-right: 0.5rem;">Export (with prereqs)</a>
        <a href="{% url 'core:skill_plan_export' plan.id %}?prereqs=0&known=0" class="btn" style="margin-right: 0.5rem;">Export (plan only)</a>
        <a href="{% url 'core:skill_plan_list' %}">Back to Plans</a>
    </div>
</div>

{% if plan.description %}
<div class="card" style="margin-bottom: 1rem;">
    <p>{{ plan.description }}</p>
</div>
{% endif %}

<!-- Multi-pilot progress summary -->
<div class="card" style="margin-bottom: 1rem;">
    <h2 style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="var el = document.getElementById('pilot-details'); el.style.display = el.style.display === 'none' ? 'block' : 'none';">
        <span>
            {{ entries|length }} skills
            {% if total_pilots > 0 %}
            | {{ completed_pilots }}/{{ total_pilots }} pilots completed
            {% endif %}
        </span>
        <span style="font-size: 0.9rem; color: #666;">▼ Click to expand</span>
    </h2>
    <div id="pilot-details" style="margin-top: 1rem; display: none;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid #ddd;">
                    <th style="padding: 0.5rem; text-align: left;">Pilot</th>
                    <th style="padding: 0.5rem; text-align: center;">Skills Complete</th>
                    <th style="padding: 0.5rem; text-align: center;">%</th>
                    <th style="padding: 0.5rem; text-align: left;">Est. Remaining</th>
                </tr>
            </thead>
            <tbody>
                {% for pilot in pilot_progress %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 0.5rem;">
                        <a href="{% url 'core:character_overview' pilot.character.id %}" style="text-decoration: none; color: inherit;">
                            {{ pilot.character.name }}
                        </a>
                    </td>
                    <td style="padding: 0.5rem; text-align: center;">
                        {{ pilot.progress.completed }}/{{ pilot.progress.total_entries }}
                    </td>
                    <td style="padding: 0.5rem; text-align: center; width: 150px;">
                        <div style="background: #eee; height: 8px; border-radius: 4px; overflow: hidden; margin: 0 auto;">
                            <div style="background: {% if pilot.percent_complete == 100 %}#080{% elif pilot.percent_complete >= 50 %}#cc0{% else %}#c00{% endif %}; height: 100%; width: {{ pilot.percent_complete }}%;"></div>
                        </div>
                        <span style="font-size: 0.85rem; color: #666;">{{ pilot.percent_complete|floatformat:0 }}%</span>
                    </td>
                    <td style="padding: 0.5rem; font-size: 0.9rem;">
                        {% if pilot.percent_complete == 100 %}
                            <span style="color: #080;">Complete</span>
                        {% elif pilot.total_training_seconds %}
                            {{ pilot.total_training_seconds|format_duration }}
                        {% else %}
                            <span style="color: #999;">&mdash;</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" style="padding: 1rem; text-align: center; color: #666;">
                        No characters found. Add characters to see progress.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items: start;">
    <!-- Left column: Current skills -->
    <div class="card">
        <h2>Current Skills ({{ entries|length }})</h2>
        {% if entries %}
            <ul style="list-style: none; padding: 0; margin: 0;">
                {% for entry in entries %}
                <li style="padding: 0.5rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <span>
                        <strong>{{ entry.skill.name }}</strong>
                        {% if entry.level %} → L{{ entry.level }}{% endif %}
                    </span>
                    <form method="post" action="{% url 'core:skill_plan_remove_skill' plan.id entry.id %}" style="display: inline;" onsubmit="return confirm('Remove this skill from the plan?');">
                        {% csrf_token %}
                        <button type="submit" style="background: none; border: none; color: #c00; cursor: pointer; text-decoration: underline; font-size: 0.85rem;">Remove</button>
                    </form>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p style="color: #666;">No skills in this plan yet.</p>
        {% endif %}
    </div>

    <!-- Right column: Import textarea -->
    <div class="card">
        <h2>Import Skills</h2>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">
            Paste skills from clipboard to add to this plan. Imported skills will be added to existing skills.
        </p>
        <form method="post" action="{% url 'core:skill_plan_import_skills' plan.id %}">
            {% csrf_token %}
            <textarea name="skills" rows="15" style="width: 100%; padding: 0.5rem; font-family: monospace; font-size: 0.9rem;" placeholder="Amarr Destroyer 1
Amarr Battleship V
Gallente Cruiser 3
..."></textarea>
            <p style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">
                <strong>Format:</strong> One skill per line: <code>SKILL_NAME LEVEL</code><br>
                Level can be 1-5 or I-V (Roman numerals optional).<br>
                Example: <code>Amarr Battleship V</code> or <code>Amarr Battleship 5</code>
            </p>
            <button type="submit" class="btn">Import Skills</button>
        </form>
    </div>
</div>
{% endblock %}
