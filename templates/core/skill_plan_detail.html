{% extends "base.html" %}
{% load evewire %}

{% block title %}{{ plan.name }} - Skill Plans - evewire{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h1>{{ plan.name }}</h1>
    <div>
        <a href="{% url 'core:skill_plan_edit' plan.id %}" class="btn" style="margin-right: 0.5rem;">Edit Plan</a>
        <a href="{% url 'core:skill_plan_export' plan.id %}?prereqs=1&known=0" class="btn" style="margin-right: 0.5rem;">Export (with prereqs)</a>
        <a href="{% url 'core:skill_plan_export' plan.id %}?prereqs=0&known=0" class="btn" style="margin-right: 0.5rem;">Export (plan only)</a>
        <a href="{% url 'core:skill_plan_list' %}">Back to Plans</a>
    </div>
</div>

{% if plan.description %}
<div class="card" style="margin-bottom: 1rem;">
    <p>{{ plan.description }}</p>
</div>
{% endif %}

{% if progress %}
<div class="card" style="margin-bottom: 1rem;">
    <h2>Progress</h2>
    <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
        <div>
            <strong>{{ progress.percent_complete|floatformat:1 }}%</strong> Complete
        </div>
        <div>
            <strong>{{ progress.completed }}</strong> / {{ progress.total_entries }} Required
        </div>
        <div>
            <strong>{{ progress.in_progress }}</strong> In Progress
        </div>
        <div>
            <strong>{{ progress.not_started }}</strong> Not Started
        </div>
        {% if total_training_seconds %}
        <div>
            <strong>{{ total_training_seconds|format_duration }}</strong> Total Time
        </div>
        {% endif %}
    </div>
    <div style="background: #eee; height: 20px; border-radius: 4px; overflow: hidden;">
        <div style="background: #080; height: 100%; width: {{ progress.percent_complete }}%;"></div>
    </div>
</div>
{% endif %}

<div class="card">
    <h2>Skills</h2>
    {% if character %}
    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
        <span>Show:</span>
        <a href="{% url 'core:skill_plan_detail' plan.id %}?show=all" style="{% if show_filter == 'all' %}font-weight: bold; color: #000;{% endif %}">All</a>
        <a href="{% url 'core:skill_plan_detail' plan.id %}?show=trainable" style="{% if show_filter == 'trainable' %}font-weight: bold; color: #000;{% endif %}">Trainable</a>
        <a href="{% url 'core:skill_plan_detail' plan.id %}?show=blocked" style="{% if show_filter == 'blocked' %}font-weight: bold; color: #000;{% endif %}">Blocked</a>
    </div>
    {% endif %}
    {% if entries %}
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid #ddd;">
                    <th style="padding: 0.5rem; text-align: left;">Skill</th>
                    <th style="padding: 0.5rem; text-align: center;">Required</th>
                    <th style="padding: 0.5rem; text-align: center;">Recommended</th>
                    <th style="padding: 0.5rem; text-align: center;">Current</th>
                    <th style="padding: 0.5rem; text-align: left;">Prerequisites</th>
                    <th style="padding: 0.5rem; text-align: left;">Status</th>
                    <th style="padding: 0.5rem; text-align: left;">Training Time</th>
                    <th style="padding: 0.5rem; text-align: left;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in entries %}
                <tr style="border-bottom: 1px solid #eee; {% if item.status == 'completed' %}background: #e6f7e6;{% elif item.trainable_status == 'blocked' %}background: #fff3f3;{% endif %}"
                    {% if item.prereq_info %}data-prereqs="{{ item.entry.skill_id }}"{% endif %}>
                    <td style="padding: 0.5rem;">
                        <strong>{{ item.entry.skill_name }}</strong>
                        {% if item.trainable_status == 'blocked' %}
                            <span style="color: #c00; font-size: 0.8rem; margin-left: 0.5rem;">ðŸ”’ Blocked</span>
                        {% elif item.trainable_status == 'trainable' %}
                            <span style="color: #080; font-size: 0.8rem; margin-left: 0.5rem;">âœ“ Ready</span>
                        {% endif %}
                    </td>
                    <td style="padding: 0.5rem; text-align: center;">
                        {% if item.entry.level %}L{{ item.entry.level }}{% else %}&mdash;{% endif %}
                    </td>
                    <td style="padding: 0.5rem; text-align: center;">
                        {% if item.entry.recommended_level %}L{{ item.entry.recommended_level }}{% else %}&mdash;{% endif %}
                    </td>
                    <td style="padding: 0.5rem; text-align: center;">
                        L{{ item.current_level }}
                    </td>
                    <td style="padding: 0.5rem;">
                        {% if item.prereq_info %}
                            {% if item.prereq_info.all_met %}
                                <span style="color: #080;">âœ“ All met</span>
                            {% else %}
                                <span style="color: #c00;"
                                      onmouseover="showPrereqs({{ item.entry.skill_id }}, event)"
                                      onmouseout="hidePrereqs()"
                                      style="cursor: help;">
                                    {{ item.prereq_info.met_count }}/{{ item.prereq_info.total }} met
                                </span>
                                <span style="font-size: 0.8rem; color: #999;">(hover)</span>
                            {% endif %}
                        {% else %}
                            <span style="color: #999;">&mdash;</span>
                        {% endif %}
                    </td>
                    <td style="padding: 0.5rem;">
                        {% if item.status == 'completed' %}
                            <span style="color: #080; font-weight: bold;">âœ“ Complete</span>
                        {% elif item.status == 'recommended' %}
                            <span style="color: #060; font-weight: bold;">âœ“ Recommended Met</span>
                        {% elif item.status == 'in_progress' %}
                            <span style="color: #c60;">In Progress</span>
                        {% elif item.status == 'not_started' %}
                            <span style="color: #666;">Not Started</span>
                        {% else %}
                            <span style="color: #999;">Unknown</span>
                        {% endif %}
                    </td>
                    <td style="padding: 0.5rem; font-size: 0.9rem;">
                        {% if item.status == 'completed' %}
                            <span style="color: #080;">Complete</span>
                        {% elif item.training_time %}
                            {% if item.training_time.total_seconds > 0 %}
                                {{ item.training_time.total_seconds|format_duration }}
                            {% else %}
                                <span style="color: #999;">Ready</span>
                            {% endif %}
                        {% else %}
                            <span style="color: #999;">&mdash;</span>
                        {% endif %}
                    </td>
                    <td style="padding: 0.5rem;">
                        <form method="post" action="{% url 'core:skill_plan_remove_skill' plan.id item.entry.id %}" style="display: inline;" onsubmit="return confirm('Remove this skill from the plan?');">
                            {% csrf_token %}
                            <button type="submit" style="background: none; border: none; color: #c00; cursor: pointer; text-decoration: underline;">Remove</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p style="color: #666;">No skills in this plan yet.</p>
    {% endif %}

    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
        <h3>Add Skill</h3>
        <form method="post" action="{% url 'core:skill_plan_add_skill' plan.id %}" style="display: flex; gap: 0.5rem; align-items: center;">
            {% csrf_token %}
            <input type="text" id="skill_search" name="skill_id" placeholder="Search skills by name..." required style="padding: 0.5rem; min-width: 300px;" list="skill_results">
            <datalist id="skill_results"></datalist>
            <select name="level" style="padding: 0.5rem;">
                <option value="">Required Level</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
            <select name="recommended_level" style="padding: 0.5rem;">
                <option value="">Recommended Level</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
            </select>
            <button type="submit" class="btn">Add Skill</button>
        </form>
        <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
            Start typing a skill name to search. Results will show the skill name and ID.
        </p>
    </div>
    <script>
    (function() {
        const searchInput = document.getElementById('skill_search');
        const datalist = document.getElementById('skill_results');
        let debounceTimer;

        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            const query = this.value.trim();

            if (query.length < 2) {
                datalist.innerHTML = '';
                return;
            }

            debounceTimer = setTimeout(function() {
                fetch('{% url "core:skill_search" %}?q=' + encodeURIComponent(query))
                    .then(response => response.json())
                    .then(data => {
                        datalist.innerHTML = '';
                        data.results.forEach(skill => {
                            const option = document.createElement('option');
                            option.value = skill.id;
                            option.textContent = skill.text;
                            datalist.appendChild(option);
                        });
                    })
                    .catch(err => console.error('Search failed:', err));
            }, 300);
        });
    })();

    // Prerequisite tooltip data and functions
    const prereqData = {
        {% for item in entries %}
            {% if item.prereq_info and not item.prereq_info.all_met %}
            '{{ item.entry.skill_id }}': {
                skillName: '{{ item.entry.skill_name }}',
                unmet: [
                    {% for prereq in item.prereq_info.unmet %}
                    {
                        skillName: '{{ prereq.skill_name }}',
                        requiredLevel: {{ prereq.required_level }},
                        currentLevel: {{ prereq.current_level }},
                        type: '{{ prereq.type }}',
                        depth: {{ prereq.depth }}
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]
            }{% if not forloop.last %},{% endif %}
            {% endif %}
        {% endfor %}
    };

    const prereqTooltip = document.createElement('div');
    prereqTooltip.style.position = 'absolute';
    prereqTooltip.style.background = '#fff';
    prereqTooltip.style.border = '1px solid #ccc';
    prereqTooltip.style.borderRadius = '4px';
    prereqTooltip.style.padding = '0.75rem';
    prereqTooltip.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
    prereqTooltip.style.zIndex = '1000';
    prereqTooltip.style.maxWidth = '350px';
    prereqTooltip.style.display = 'none';
    document.body.appendChild(prereqTooltip);

    function showPrereqs(skillId, event) {
        const data = prereqData[skillId];
        if (!data || data.unmet.length === 0) return;

        let html = `<strong style="color: #c00;">Unmet Prerequisites for ${data.skillName}:</strong><ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">`;
        for (const prereq of data.unmet) {
            const indent = 'â€ƒ'.repeat(prereq.depth);
            const icon = prereq.type === 'direct' ? 'ðŸ”´' : 'â†³';
            html += `<li style="margin-bottom: 0.25rem;">${indent}${icon} ${prereq.skillName} L${prereq.requiredLevel} (have L${prereq.currentLevel})</li>`;
        }
        html += '</ul>';

        prereqTooltip.innerHTML = html;
        prereqTooltip.style.display = 'block';

        // Position tooltip
        const rect = event.target.getBoundingClientRect();
        prereqTooltip.style.top = (rect.bottom + window.scrollY + 8) + 'px';
        prereqTooltip.style.left = Math.max(8, Math.min(rect.left + window.scrollX, window.innerWidth - 360)) + 'px';
    }

    function hidePrereqs() {
        prereqTooltip.style.display = 'none';
    }
    </script>
</div>
{% endblock %}
