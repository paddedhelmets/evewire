{% extends "base.html" %}
{% load evewire %}

{% block title %}Fittings - evewire{% endblock %}

{% block extra_head %}
<style>
    .fittings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .fittings-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .fittings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1rem;
    }

    .fitting-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        transition: box-shadow 0.2s;
    }

    .fitting-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .fitting-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 0.75rem;
    }

    .fitting-name {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .fitting-name a {
        color: inherit;
        text-decoration: none;
    }

    .fitting-name a:hover {
        color: var(--link-color);
    }

    .fitting-ship {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .fitting-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        margin-bottom: 0.75rem;
    }

    .fitting-tag {
        background: var(--btn-primary);
        color: white;
        padding: 0.1rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
    }

    .fitting-matches {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .match-chip {
        font-size: 0.85rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        background: #e8f5e9;
        color: #2e7d32;
    }

    .match-chip.none {
        background: var(--bg-primary);
        color: var(--text-secondary);
    }

    [data-theme="dark"] .match-chip {
        background: #1b5e20;
        color: #81c784;
    }

    [data-theme="dark"] .match-chip.none {
        background: var(--bg-secondary);
        color: var(--text-secondary);
    }

    .fitting-status {
        font-size: 0.8rem;
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
    }

    .fitting-status.active {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .fitting-status.inactive {
        background: var(--bg-primary);
        color: var(--text-secondary);
    }

    [data-theme="dark"] .fitting-status.active {
        background: #1b5e20;
        color: #81c784;
    }

    [data-theme="dark"] .fitting-status.inactive {
        background: var(--bg-secondary);
        color: var(--text-secondary);
    }

    /* Ignore button */
    .ignore-btn {
        padding: 0.2rem 0.5rem;
        font-size: 0.75rem;
        border: 1px solid var(--border-color);
        background: var(--bg-primary);
        color: var(--text-secondary);
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .ignore-btn:hover {
        background: var(--bg-secondary);
    }

    .ignore-btn[data-is-ignored="true"] {
        background: #fff3e0;
        color: #e65100;
        border-color: #ff9800;
    }

    [data-theme="dark"] .ignore-btn[data-is-ignored="true"] {
        background: #3e2723;
        color: #ffab91;
        border-color: #ff5722;
    }

    /* Hidden fittings banner */
    .hidden-banner {
        background: #fff3e0;
        border-color: #ff9800;
    }

    [data-theme="dark"] .hidden-banner {
        background: #3e2723;
        border-color: #ff5722;
    }

    [data-theme="dark"] .hidden-banner h3 {
        color: #ffab91;
    }

    [data-theme="dark"] .hidden-banner p {
        color: #ffccbc;
    }
</style>
{% endblock %}

{% block content %}
<div class="fittings-header">
    <h1>Fittings</h1>
    <div class="fittings-actions">
        <a href="{% url 'core:fitting_import' %}" class="btn">Import</a>
        <a href="{% url 'core:fitting_bulk_import' %}" class="btn">Bulk Import</a>
        {% if character %}
            <a href="{% url 'core:fitting_matches' character.id %}" class="btn">View My Matches</a>
        {% else %}
            <a href="{% url 'core:fitting_matches' %}" class="btn">View My Matches</a>
        {% endif %}
    </div>
</div>

<div class="card">
    <h2>Filter Fittings</h2>
    <form method="get" style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
        <select name="ship_type" style="padding: 0.5rem;">
            <option value="">All Ships</option>
            {% for ship in ship_types %}
            <option value="{{ ship.id }}" {% if ship_type_filter == ship.id|stringformat:"s" %}selected{% endif %}>
                {{ ship.name }}
            </option>
            {% endfor %}
        </select>
        <select name="tag" style="padding: 0.5rem;">
            <option value="">All Tags</option>
            {% for tag in all_tags %}
            <option value="{{ tag }}" {% if tag_filter == tag %}selected{% endif %}>
                {{ tag|title }}
            </option>
            {% endfor %}
        </select>
        <input type="text" name="search" placeholder="Search fittings..." value="{{ search_query }}" style="padding: 0.5rem;">
        <button type="submit" class="btn">Filter</button>
        <a href="{% url 'core:fittings_list' %}" style="margin-left: 0.5rem;">Clear</a>

        <!-- Hidden toggle -->
        <div style="margin-left: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="show_hidden" value="1" {% if show_hidden %}checked{% endif %} id="show-hidden-toggle" style="cursor: pointer;">
                <span style="font-size: 0.9rem;">Show hidden fittings</span>
            </label>
        </div>
    </form>
</div>

{% if show_hidden %}
<div class="card hidden-banner" style="border-style: solid;">
    <h3 style="margin: 0 0 0.5rem 0;">Hidden Fittings ({{ fittings_with_matches|length }})</h3>
    <p style="margin: 0; font-size: 0.9rem;">These are global fittings you've chosen to hide. Use "Unignore" to restore them to your main list.</p>
</div>
{% endif %}

{% if ship_type_filter or search_query or tag_filter %}
<div class="card">
    <h3>Filtered Results ({{ fittings_with_matches|length }} result{{ fittings_with_matches|length|pluralize }})</h3>
</div>
{% endif %}

<div class="fittings-grid">
    {% for item in fittings_with_matches %}
    <div class="fitting-card" data-fitting-id="{{ item.fitting.id }}">
        <div class="fitting-header">
            <div>
                <div class="fitting-name">
                    {% if item.fitting.is_pinned %}<span style="color: #f57c00;">â˜…</span>{% endif %}
                    <a href="{% url 'core:fitting_detail' item.fitting.id %}">{{ item.fitting.name }}</a>
                </div>
                <div class="fitting-ship">{{ item.fitting.ship_type_name }}</div>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <div class="fitting-status {% if item.fitting.is_active %}active{% else %}inactive{% endif %}">
                    {% if item.fitting.is_active %}Active{% else %}Inactive{% endif %}
                </div>
                {% if item.is_global %}
                <button class="ignore-btn btn-sm" data-fitting-id="{{ item.fitting.id }}" data-is-ignored="{{ item.is_ignored|yesno:'true,false' }}">
                    {% if item.is_ignored %}
                    <span class="ignore-text">Unignore</span>
                    {% else %}
                    <span class="ignore-text">Ignore</span>
                    {% endif %}
                </button>
                {% endif %}
            </div>
        </div>

        {% if item.fitting.tags %}
        <div class="fitting-tags">
            {% for tag_key, tag_val in item.fitting.tags.items %}
            <span class="fitting-tag">{{ tag_key }}: {{ tag_val }}</span>
            {% endfor %}
        </div>
        {% endif %}

        <div class="fitting-matches">
            {% if item.match_count > 0 %}
                <strong style="font-size: 0.9rem;">{{ item.match_count }} match{{ item.match_count|pluralize }}:</strong>
                {% for char_id, count in item.matches_by_character.items %}
                    {% for char in all_characters %}
                        {% if char.id == char_id %}
                        <span class="match-chip">{{ char.character_name }}: {{ count }}</span>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% else %}
                <span class="match-chip none">No matching ships</span>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

{% if not fittings_with_matches %}
<div class="card">
    <p style="color: var(--text-secondary);">No fittings match your filter.</p>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit form when show-hidden toggle changes
    const showHiddenToggle = document.getElementById('show-hidden-toggle');
    if (showHiddenToggle) {
        showHiddenToggle.addEventListener('change', function() {
            this.closest('form').submit();
        });
    }

    // Handle ignore button clicks
    const ignoreButtons = document.querySelectorAll('.ignore-btn');

    ignoreButtons.forEach(button => {
        button.addEventListener('click', async function(e) {
            e.preventDefault();
            const fittingId = this.dataset.fittingId;
            const isIgnored = this.dataset.isIgnored === 'true';
            const card = this.closest('.fitting-card');
            const url = `/fittings/${fittingId}/ignore-toggle/`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const data = await response.json();

                    // When in hidden view, unignoring removes the card from the list
                    // When in normal view, ignoring removes the card from the list
                    // In both cases, we can reload the page to show the updated list
                    if (data.status === 'ignored' || data.status === 'unignored') {
                        // Reload the page to show updated list
                        window.location.reload();
                    }
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to toggle ignore status');
                }
            } catch (error) {
                console.error('Error toggling ignore:', error);
                alert('Failed to toggle ignore status');
            }
        });
    });
});
</script>
{% endblock %}
