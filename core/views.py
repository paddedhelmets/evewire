"""
Core views for evewire.

Includes authentication, dashboard, and character views.
"""

import logging
from django.shortcuts import render, redirect
from django.contrib.auth import login, logout
from django.contrib.auth.decorators import login_required
from django.views.decorators.http import require_http_methods
from django.http import HttpRequest, HttpResponse
from django.urls import reverse

logger = logging.getLogger('evewire')


def index(request: HttpRequest) -> HttpResponse:
    """Landing page - show login button or redirect to dashboard."""
    if request.user.is_authenticated:
        return redirect('dashboard')
    return render(request, 'core/index.html')


@require_http_methods(['GET', 'POST'])
def login_view(request: HttpRequest) -> HttpResponse:
    """Initiate EVE SSO login flow."""
    from core.services import TokenManager

    if request.user.is_authenticated:
        return redirect('dashboard')

    sso_url = TokenManager.get_sso_login_url()
    return redirect(sso_url)


def oauth_callback(request: HttpRequest) -> HttpResponse:
    """Handle EVE SSO OAuth callback."""
    from core.services import AuthService

    code = request.GET.get('code')
    error = request.GET.get('error')
    error_description = request.GET.get('error_description')

    if error:
        logger.error(f'OAuth error: {error} - {error_description}')
        return render(request, 'core/auth_error.html', {
            'error': error,
            'error_description': error_description,
        })

    if not code:
        logger.error('OAuth callback missing code parameter')
        return render(request, 'core/auth_error.html', {
            'error': 'Missing authorization code',
        })

    try:
        user = AuthService.handle_callback(code)
        login(request, user)
        logger.info(f'User {user.eve_character_name} logged in via SSO')
        return redirect('dashboard')

    except Exception as e:
        logger.error(f'Failed to handle OAuth callback: {e}')
        return render(request, 'core/auth_error.html', {
            'error': 'Authentication failed',
            'error_description': str(e),
        })


@login_required
def logout_view(request: HttpRequest) -> HttpResponse:
    """Log out the current user."""
    logger.info(f'User {request.user.eve_character_name} logged out')
    logout(request)
    return redirect('index')


@login_required
def dashboard(request: HttpRequest) -> HttpResponse:
    """Main dashboard showing user's characters."""
    from core.models import Character

    # For MVP, user has 1:1 character relationship
    try:
        character = Character.objects.get(user=request.user)
        # Prefetch related data for efficient display
        character = Character.objects.select_related('user').get(id=character.id)
    except Character.DoesNotExist:
        character = None

    return render(request, 'core/dashboard.html', {
        'character': character,
    })


@login_required
def character_detail(request: HttpRequest, character_id: int) -> HttpResponse:
    """Detailed view of a single character."""
    from core.models import Character
    from django.utils import timezone
    from datetime import timedelta

    try:
        character = Character.objects.select_related('user').get(id=character_id, user=request.user)
    except Character.DoesNotExist:
        return render(request, 'core/error.html', {
            'message': 'Character not found',
        }, status=404)

    # Fetch skills with prefetch for item types
    skills = character.skills.all().select_related('skill_id')
    skills_count = skills.count()

    # Fetch skill queue
    skill_queue = character.skill_queue.all().order_by('queue_position')
    queue_count = skill_queue.count()

    # Check if queue is empty or expiring soon (within 24 hours)
    queue_empty = queue_count == 0
    queue_expiring_soon = False
    if queue_count > 0:
        last_item = skill_queue.last()
        if last_item.finish_date <= timezone.now() + timedelta(hours=24):
            queue_expiring_soon = True

    # Fetch active market orders
    active_orders = character.market_orders.filter(state='open')
    orders_count = active_orders.count()

    # Calculate total order value
    orders_value = sum(float(order.price * order.volume_remain) for order in active_orders)

    return render(request, 'core/character_detail.html', {
        'character': character,
        'skills': skills,
        'skills_count': skills_count,
        'skill_queue': skill_queue,
        'queue_count': queue_count,
        'queue_empty': queue_empty,
        'queue_expiring_soon': queue_expiring_soon,
        'active_orders': active_orders,
        'orders_count': orders_count,
        'orders_value': orders_value,
    })


@login_required
def character_skills(request: HttpRequest, character_id: int) -> HttpResponse:
    """View all skills for a character, grouped by category."""
    from core.models import Character
    from core.eve.models import ItemType
    from collections import defaultdict

    try:
        character = Character.objects.select_related('user').get(id=character_id, user=request.user)
    except Character.DoesNotExist:
        return render(request, 'core/error.html', {
            'message': 'Character not found',
        }, status=404)

    # Fetch all skills with their item types
    skills = character.skills.all().select_related()

    # Group skills by category_id
    skills_by_category = defaultdict(list)
    category_names = {}

    # Category ID to name mapping (EVE skill categories)
    category_map = {
        16: 'Corporation Management',
        17: 'Drones',
        18: 'Industry',
        19: 'Leadership',
        20: 'Learning',  # Deprecated but may exist
        21: 'Social',
        22: 'Trade',
        23: 'Gunnery',
        24: 'Flight Control',
        25: 'Missiles',
        26: 'Navigation',
        27: 'Shields',
        28: 'Mechanical',
        29: 'Electronic Systems',
        30: 'Engineering',
        31: 'Subsystems',  # T3 ship subsystems
        128: 'Starship Command',
        129: 'Spaceship Command',
        130: 'Frigate',
        131: 'Cruiser',
        132: 'Battleship',
        133: 'Industrial',
        134: 'Capital Ships',
        135: 'Advanced Spaceship Command',
        136: 'Trade Skills',  # Duplicate?
        137: 'Resources',
        138: 'Processing',
        139: 'Ore Industrial',
        140: 'Planet Management',
        141: 'Planetary Interaction',
        142: 'Planetary Commodities',
        143: 'Defense Systems',
        144: 'Electronic Warfare',
        145: 'Targeting',
        146: 'Weapon Upgrades',
        147: 'Ammo',
        148: 'Turret Weapons',
        149: 'Missile Launcher',
        150: 'Missile Operation',
        151: 'Drones',  # Duplicate?
        152: 'Scanning',
        153: 'Science',
        154: 'Hacking',
        155: 'Archeology',
        156: 'Salvaging',
        157: 'Neural Enhancement',
        158: 'Core Systems',
        159: 'Rigging',
        160: 'Astronautics',
        161: 'Planet Conservation',
        162: 'Structure',
        163: 'Trading',
        164: 'Politic',
        165: 'Security',
        166: 'Distribution',
        167: 'Manufacturing',
        168: 'Reprocessing',
        169: 'Refining',
        170: 'Oil',
        171: 'Science',
        172: 'Construction',
        173: 'Recycling',
        174: 'Distribution',
        257: 'Armor',
        258: 'Shooting',
        259: 'Corporation Management',
        260: 'GM',
        261: 'Connectors',
        262: 'Capitals',
        263: 'Logistics',
        264: 'Support',
        265: 'Infantry',
        266: 'Gunnery',
        267: 'Navigation',
        268: 'Missiles',
        269: 'Electronic Systems',
        270: 'Mechanical',
        271: 'Engineering',
        272: 'Shields',
        273: 'Targeting',
        274: 'Leadership',
        275: 'Trade',
        276: 'Corporation Management',
        277: 'Industry',
        278: 'Drones',
        279: 'Social',
        280: 'Scanning',
        281: 'Advanced Industry',
        282: 'Production',
        283: 'Infrastructure',
        284: 'Logistics',
        285: 'Tactical Destroyer',
        286: 'Strategic Cruiser',
        287: 'Command',
        288: 'Recon',
        289: 'Heavy Assault',
        290: 'Logistics',
        291: 'Electronic Warfare',
        292: 'Interceptors',
        293: 'CovOps',
        294: 'Transport',
        295: 'Freighter',
        296: 'Exhumers',
        297: 'Mining Frigate',
        298: 'Battlecruiser',
        299: 'Destroyer',
        300: 'Battlecruiser',
        301: 'Command',
        302: 'Force',
        303: 'Infrastructure',
        304: 'Infantry',
        305: 'Infantry Gear',
        306: 'Infantry Weapons',
        307: 'Infantry Equipment',
        308: 'Infantry Vehicles',
        309: 'Ammunition',
        310: 'Electronic Systems',
        311: 'Engineering',
        312: 'Mechanical',
        313: 'Weapons',
        314: 'Shields',
        315: 'Frigate',
        316: 'Cruiser',
        317: 'Battleship',
        318: 'Industrial',
        319: 'Capital Ships',
        320: 'Advanced Spaceship Command',
        321: 'Trade',
        322: 'Corporation Management',
        323: 'Industry',
        324: 'Drones',
        325: 'Social',
        326: 'Leadership',
        327: 'Scanning',
        328: 'Navigation',
        329: 'Gunnery',
        330: 'Missiles',
        331: 'Shields',
        332: 'Mechanical',
        333: 'Electronic Systems',
        334: 'Engineering',
        335: 'Armor',
        336: 'Targeting',
        337: 'Weapon Upgrades',
        338: 'Electronic Warfare',
        339: 'Cloaking',
        340: 'Propulsion',
        341: 'Laser',
        342: 'Projectile',
        343: 'Hybrid',
        344: 'Autocannons',
        345: 'Missiles',
        346: 'Drones',
        347: 'Scanning',
        348: 'Repair',
        349: 'Construction',
        350: 'Ore',
        351: 'Gases',
        352: 'PI Materials',
        353: 'Datacores',
        354: 'Decryptors',
        355: 'Invention',
        356: 'Manufacturing',
        357: 'Research',
        358: 'Reverse Engineering',
        359: 'Copying',
        359: 'Exploration',
        360: 'Deep Space Transport',
        361: 'Capital Industrial',
        362: 'Force Auxiliary',
        363: 'Command Destroyer',
        364: 'FAX',
        365: 'Tactical Destroyer',
        366: 'Strategic Cruiser',
        367: 'Expedition Frigates',
        368: 'Logistics Frigates',
        369: 'Support Frigates',
        370: 'Combat Battleships',
        371: 'Attack Battlecruisers',
        372: 'Combat Battlecruisers',
        373: 'Disruption Cruisers',
        374: 'Combat Cruisers',
        375: 'Attack Cruisers',
        376: 'Support Cruisers',
        377: 'Bloker',
        378: 'Command Cruisers',
        379: 'Attack Frigates',
        380: 'Combat Frigates',
        381: 'Support Frigates',
        382: 'Exploration Frigates',
        383: 'Cov Ops Frigates',
        384: 'Electronic Attack Frigates',
        385: 'Stealth Bombers',
        386: 'Mining Frigates',
        387: 'Hauling',
        388: 'Mining',
        389: 'Capital Ships',
        390: 'Logistics',
        391: 'Command',
        392: 'Recon',
        393: 'Heavy Assault',
        394: 'Logistics',
        395: 'Electronic Warfare',
        396: 'Interceptors',
        397: 'CovOps',
        398: 'Transport',
        399: 'Freighter',
        400: 'Exhumers',
        401: 'Mining Frigate',
        402: 'Battlecruiser',
        403: 'Destroyer',
        404: 'Command',
        405: 'Force',
        406: 'Infrastructure',
        407: 'Infantry',
        408: 'Infantry Gear',
        409: 'Infantry Weapons',
        410: 'Infantry Equipment',
        411: 'Infantry Vehicles',
        412: 'Ammunition',
        413: 'Armor',
        414: 'Shields',
        415: 'Engineering',
        416: 'Gunnery',
        417: 'Missiles',
        418: 'Electronic Warfare',
        419: 'Navigation',
        420: 'Drones',
        421: 'Industry',
        422: 'Trade',
        423: 'Social',
        424: 'Corporation Management',
        425: 'Leadership',
        426: 'Scanning',
        427: 'Advanced Industry',
        428: 'PI Materials',
        429: 'Datacores',
        430: 'Decryptors',
        431: 'Invention',
        432: 'Manufacturing',
        433: 'Research',
        434: 'Reverse Engineering',
        435: 'Copying',
        436: 'Materials',
        437: 'Commodities',
        438: 'Ships',
        439: 'Ship Equipment',
        440: 'Modules',
        441: 'Ammunition & Charges',
        442: 'Implants & Boosters',
        443: 'Drones',
        444: 'Rigs',
        445: 'Subsystems',
        446: 'Deployables',
        447: 'Structures',
        448: 'Structure Equipment',
        449: 'Structure Services',
        450: 'Fuel',
        451: 'Consumables',
        452: 'Blueprints',
        453: 'Materials',
        454: 'Commodities',
        455: 'Ships',
        456: 'Ship Equipment',
        457: 'Modules',
        458: 'Ammunition & Charges',
        459: 'Implants & Boosters',
        460: 'Drones',
        461: 'Rigs',
        462: 'Subsystems',
        463: 'Deployables',
        464: 'Structures',
        465: 'Structure Equipment',
        466: 'Structure Services',
        467: 'Fuel',
        468: 'Consumables',
        469: 'Blueprints',
        1210: 'Shield Command',
        1211: 'Armor Resistance',
        1212: 'Engineering Rig',
        1213: 'Drone Interface',
        1214: 'Launcher',
        1215: 'Turret',
        1216: 'Missile',
        1217: 'Autocannon',
        1218: 'Blaster',
        1219: 'Railgun',
        1220: 'Beam Laser',
        1221: 'Pulse Laser',
        1222: 'Arty',
        1223: 'Cruise Missile',
        1224: 'Rocket',
        1225: 'Torpedo',
        1226: 'Smartbomb',
        1227: 'Bomb',
        1228: 'Drone',
        1229: 'Sensor',
        1230: 'Ewar',
        1231: 'Propulsion',
        1232: 'Armor',
        1233: 'Shield',
        1234: 'Capacitor',
        1235: 'Engineering',
        1236: 'Navigation',
        1237: 'Targeting',
        1238: 'Mining',
        1239: 'Trading',
        1240: 'Planet',
        1241: 'Production',
        1242: 'Industry',
        1243: 'Corporation',
        1244: 'Leadership',
        1245: 'Social',
        1246: 'Scanning',
        1247: 'Hacking',
        1248: 'Archaeology',
        1249: 'Salvage',
        1250: 'Cyberimplants',
        1251: 'Boosters',
        1252: 'Rig',
        1253: 'Subsystem',
        1254: 'Structure',
        1255: 'Service',
        1256: 'Fuel',
        1257: 'Deployable',
        1258: 'Consumable',
        1259: 'Blueprint',
        1260: 'Material',
        1261: 'Commodity',
        1262: 'Ship',
        1263: 'Module',
        1264: 'Charge',
        1265: 'Skill',
        1266: 'Implant',
        1267: 'Booster',
        1268: 'Drone',
        1269: 'Rig',
        1270: 'Subsystem',
        1271: 'Deployable',
        1272: 'Structure',
        1273: 'Service',
        1274: 'Fuel',
        1275: 'Consumable',
        1276: 'Blueprint',
        1277: 'Material',
        1278: 'Commodity',
        1279: 'Ship',
        1280: 'Module',
        1281: 'Charge',
        1282: 'Skill',
        1283: 'Implant',
        1284: 'Booster',
        1285: 'Drone',
        1286: 'Rig',
        1287: 'Subsystem',
        1288: 'Deployable',
        1289: 'Structure',
        1290: 'Service',
        1291: 'Fuel',
        1292: 'Consumable',
        1293: 'Blueprint',
        1294: 'Material',
        1295: 'Commodity',
        1296: 'Ship',
        1297: 'Module',
        1298: 'Charge',
        1299: 'Skill',
        1300: 'Implant',
        1301: 'Booster',
        1302: 'Drone',
        1303: 'Rig',
        1304: 'Subsystem',
        1305: 'Deployable',
        1306: 'Structure',
        1307: 'Service',
        1308: 'Fuel',
        1309: 'Consumable',
        1310: 'Blueprint',
        1311: 'Material',
        1312: 'Commodity',
        1313: 'Ship',
        1314: 'Module',
        1315: 'Charge',
        1316: 'Skill',
        1317: 'Implant',
        1318: 'Booster',
        1319: 'Drone',
        1320: 'Rig',
        1321: 'Subsystem',
        1322: 'Deployable',
        1323: 'Structure',
        1324: 'Service',
        1325: 'Fuel',
        1326: 'Consumable',
        1327: 'Blueprint',
        1328: 'Material',
        1329: 'Commodity',
        1330: 'Ship',
        1331: 'Module',
        1332: 'Charge',
        1333: 'Skill',
        1334: 'Implant',
        1335: 'Booster',
        1336: 'Drone',
        1337: 'Rig',
        1338: 'Subsystem',
        1339: 'Deployable',
        1340: 'Structure',
        1341: 'Service',
        1342: 'Fuel',
        1343: 'Consumable',
        1344: 'Blueprint',
        1345: 'Material',
        1346: 'Commodity',
        1347: 'Ship',
        1348: 'Module',
        1349: 'Charge',
        1350: 'Skill',
        1351: 'Implant',
        1352: 'Booster',
        1353: 'Drone',
        1354: 'Rig',
        1355: 'Subsystem',
        1356: 'Deployable',
        1357: 'Structure',
        1358: 'Service',
        1359: 'Fuel',
        1360: 'Consumable',
        1361: 'Blueprint',
        1362: 'Material',
        1363: 'Commodity',
        1364: 'Ship',
        1365: 'Module',
        1366: 'Charge',
        1367: 'Skill',
        1368: 'Implant',
        1369: 'Booster',
        1370: 'Drone',
        1371: 'Rig',
        1372: 'Subsystem',
        1373: 'Deployable',
        1374: 'Structure',
        1375: 'Service',
        1376: 'Fuel',
        1377: 'Consumable',
        1378: 'Blueprint',
        1379: 'Material',
        1380: 'Commodity',
        1381: 'Ship',
        1382: 'Module',
        1383: 'Charge',
        1384: 'Skill',
        1385: 'Implant',
        1386: 'Booster',
        1387: 'Drone',
        1388: 'Rig',
        1389: 'Subsystem',
        1390: 'Deployable',
        1391: 'Structure',
        1392: 'Service',
        1393: 'Fuel',
        1394: 'Consumable',
        1395: 'Blueprint',
        1396: 'Material',
        1397: 'Commodity',
        1398: 'Ship',
        1399: 'Module',
        1400: 'Charge',
        1401: 'Skill',
        1402: 'Implant',
        1403: 'Booster',
        1404: 'Drone',
        1405: 'Rig',
        1406: 'Subsystem',
        1407: 'Deployable',
        1408: 'Structure',
        1409: 'Service',
        1410: 'Fuel',
        1411: 'Consumable',
        1412: 'Blueprint',
        1413: 'Material',
        1414: 'Commodity',
        1415: 'Ship',
        1416: 'Module',
        1417: 'Charge',
        1418: 'Skill',
        1419: 'Implant',
        1420: 'Booster',
        1421: 'Drone',
        1422: 'Rig',
        1423: 'Subsystem',
        1424: 'Deployable',
        1425: 'Structure',
        1426: 'Service',
        1427: 'Fuel',
        1428: 'Consumable',
        1429: 'Blueprint',
        1430: 'Material',
        1431: 'Commodity',
        1432: 'Ship',
        1433: 'Module',
        1434: 'Charge',
        1435: 'Skill',
        1436: 'Implant',
        1437: 'Booster',
        1438: 'Drone',
        1439: 'Rig',
        1440: 'Subsystem',
        1441: 'Deployable',
        1442: 'Structure',
        1443: 'Service',
        1444: 'Fuel',
        1445: 'Consumable',
        1446: 'Blueprint',
        1447: 'Material',
        1448: 'Commodity',
        1449: 'Ship',
        1450: 'Module',
        1451: 'Charge',
        1452: 'Skill',
        1453: 'Implant',
        1454: 'Booster',
        1455: 'Drone',
        1456: 'Rig',
        1457: 'Subsystem',
        1458: 'Deployable',
        1459: 'Structure',
        1460: 'Service',
        1461: 'Fuel',
        1462: 'Consumable',
        1463: 'Blueprint',
        1464: 'Material',
        1465: 'Commodity',
        1466: 'Ship',
        1467: 'Module',
        1468: 'Charge',
        1469: 'Skill',
        1470: 'Implant',
        1471: 'Booster',
        1472: 'Drone',
        1473: 'Rig',
        1474: 'Subsystem',
        1475: 'Deployable',
        1476: 'Structure',
        1477: 'Service',
        1478: 'Fuel',
        1479: 'Consumable',
        1480: 'Blueprint',
        1481: 'Material',
        1482: 'Commodity',
        1483: 'Ship',
        1484: 'Module',
        1485: 'Charge',
        1486: 'Skill',
        1487: 'Implant',
        1488: 'Booster',
        1489: 'Drone',
        1490: 'Rig',
        1491: 'Subsystem',
        1492: 'Deployable',
        1493: 'Structure',
        1494: 'Service',
        1495: 'Fuel',
        1496: 'Consumable',
        1497: 'Blueprint',
        1498: 'Material',
        1499: 'Commodity',
        1500: 'Ship',
        1501: 'Module',
        1502: 'Charge',
        1503: 'Skill',
        1504: 'Implant',
        1505: 'Booster',
        1506: 'Drones',
        1507: 'Rig',
        1508: 'Subsystem',
        1509: 'Deployable',
        1510: 'Structure',
        1511: 'Service',
        1512: 'Fuel',
        1513: 'Consumable',
        1514: 'Blueprint',
        1515: 'Material',
        1516: 'Commodity',
        1517: 'Ship',
        1518: 'Module',
        1519: 'Charge',
        1520: 'Skill',
        1521: 'Implant',
        1522: 'Booster',
        1523: 'Drone',
        1524: 'Rig',
        1525: 'Subsystem',
        1526: 'Deployable',
        1527: 'Structure',
        1528: 'Service',
        1529: 'Fuel',
        1530: 'Consumable',
        1531: 'Blueprint',
        1532: 'Material',
        1533: 'Commodity',
        1534: 'Ship',
        1535: 'Module',
        1536: 'Charge',
        1537: 'Skill',
        1538: 'Implant',
        1539: 'Booster',
        1540: 'Drone',
        1541: 'Rig',
        1542: 'Subsystem',
        1543: 'Deployable',
        1544: 'Structure',
        1545: 'Service',
        1546: 'Fuel',
        1547: 'Consumable',
        1548: 'Blueprint',
        1549: 'Material',
        1550: 'Commodity',
        1551: 'Ship',
        1552: 'Module',
        1553: 'Charge',
        1554: 'Skill',
        1555: 'Implant',
        1556: 'Booster',
        1557: 'Drone',
        1558: 'Rig',
        1559: 'Subsystem',
        1560: 'Deployable',
        1561: 'Structure',
        1562: 'Service',
        1563: 'Fuel',
        1564: 'Consumable',
        1565: 'Blueprint',
        1566: 'Material',
        1567: 'Commodity',
        1568: 'Ship',
        1569: 'Module',
        1570: 'Charge',
        1571: 'Skill',
        1572: 'Implant',
        1573: 'Booster',
        1574: 'Drone',
        1575: 'Rig',
        1576: 'Subsystem',
        1577: 'Deployable',
        1578: 'Structure',
        1579: 'Service',
        1580: 'Fuel',
        1581: 'Consumable',
        1582: 'Blueprint',
        1583: 'Material',
        1584: 'Commodity',
        1585: 'Ship',
        1586: 'Module',
        1587: 'Charge',
        1588: 'Skill',
        1589: 'Implant',
        1590: 'Booster',
        1591: 'Drone',
        1592: 'Rig',
        1593: 'Subsystem',
        1594: 'Deployable',
        1595: 'Structure',
        1596: 'Service',
        1597: 'Fuel',
        1598: 'Consumable',
        1599: 'Blueprint',
        1600: 'Material',
        1601: 'Commodity',
        1602: 'Ship',
        1603: 'Module',
        1604: 'Charge',
        1605: 'Skill',
        1606: 'Implant',
        1607: 'Booster',
        1608: 'Drone',
        1609: 'Rig',
        1610: 'Subsystem',
        1611: 'Deployable',
        1612: 'Structure',
        1613: 'Service',
        1614: 'Fuel',
        1615: 'Consumable',
        1616: 'Blueprint',
        1617: 'Material',
        1618: 'Commodity',
        1619: 'Ship',
        1620: 'Module',
        1621: 'Charge',
        1622: 'Skill',
        1623: 'Implant',
        1624: 'Booster',
        1625: 'Drone',
        1626: 'Rig',
        1627: 'Subsystem',
        1628: 'Deployable',
        1629: 'Structure',
        1630: 'Service',
        1631: 'Fuel',
        1632: 'Consumable',
        1633: 'Blueprint',
        1634: 'Material',
        1635: 'Commodity',
        1636: 'Ship',
        1637: 'Module',
        1638: 'Charge',
        1639: 'Skill',
        1640: 'Implant',
        1641: 'Booster',
        1642: 'Drone',
        1643: 'Rig',
        1644: 'Subsystem',
        1645: 'Deployable',
        1646: 'Structure',
        1647: 'Service',
        1648: 'Fuel',
        1649: 'Consumable',
        1650: 'Blueprint',
        1651: 'Material',
        1652: 'Commodity',
        1653: 'Ship',
        1654: 'Module',
        1655: 'Charge',
        1656: 'Skill',
        1657: 'Implant',
        1658: 'Booster',
        1659: 'Drone',
        1660: 'Rig',
        1661: 'Subsystem',
        1662: 'Deployable',
        1663: 'Structure',
        1664: 'Service',
        1665: 'Fuel',
        1666: 'Consumable',
        1667: 'Blueprint',
        1668: 'Material',
        1669: 'Commodity',
        1670: 'Ship',
        1671: 'Module',
        1672: 'Charge',
        1673: 'Skill',
        1674: 'Character',
        1675: 'Corporation',
        1676: 'Alliance',
        1677: 'Faction',
        1678: 'System',
        1679: 'Constellation',
        1680: 'Region',
        1681: 'Station',
        1682: 'Structure',
        1683: 'Character',
        1684: 'Corporation',
        1685: 'Alliance',
        1686: 'Faction',
        1687: 'System',
        1688: 'Constellation',
        1689: 'Region',
        1690: 'Station',
        1691: 'Structure',
        1692: 'Character',
        1693: 'Corporation',
        1694: 'Alliance',
        1695: 'Faction',
        1696: 'System',
        1697: 'Constellation',
        1698: 'Region',
        1699: 'Station',
        1700: 'Structure',
        1701: 'Character',
        1702: 'Corporation',
        1703: 'Alliance',
        1704: 'Faction',
        1705: 'System',
        1706: 'Constellation',
        1707: 'Region',
        1708: 'Station',
        1709: 'Structure',
        1710: 'Character',
        1711: 'Corporation',
        1712: 'Alliance',
        1713: 'Faction',
        1714: 'System',
        1715: 'Constellation',
        1716: 'Region',
        1717: 'Station',
        1718: 'Structure',
        1719: 'Character',
        1720: 'Corporation',
        1721: 'Alliance',
        1722: 'Faction',
        1723: 'System',
        1724: 'Constellation',
        1725: 'Region',
        1726: 'Station',
        1727: 'Structure',
        1728: 'Character',
        1729: 'Corporation',
        1730: 'Alliance',
        1731: 'Faction',
        1732: 'System',
        1733: 'Constellation',
        1734: 'Region',
        1735: 'Station',
        1736: 'Structure',
        1737: 'Character',
        1738: 'Corporation',
        1739: 'Alliance',
        1740: 'Faction',
        1741: 'System',
        1742: 'Constellation',
        1743: 'Region',
        1744: 'Station',
        1745: 'Structure',
        1746: 'Character',
        1747: 'Corporation',
        1748: 'Alliance',
        1749: 'Faction',
        1750: 'System',
        1751: 'Constellation',
        1752: 'Region',
        1753: 'Station',
        1754: 'Structure',
        1755: 'Character',
        1756: 'Corporation',
        1757: 'Alliance',
        1758: 'Faction',
        1759: 'System',
        1760: 'Constellation',
        1761: 'Region',
        1762: 'Station',
        1763: 'Structure',
        1764: 'Character',
        1765: 'Corporation',
        1766: 'Alliance',
        1767: 'Facing',
        1768: 'System',
        1769: 'Constellation',
        1770: 'Region',
        1771: 'Station',
        1772: 'Structure',
        1773: 'Character',
        1774: 'Corporation',
        1775: 'Alliance',
        1776: 'Faction',
        1777: 'System',
        1778: 'Constellation',
        1779: 'Region',
        1780: 'Station',
        1781: 'Structure',
        1782: 'Character',
        1783: 'Corporation',
        1784: 'Alliance',
        1785: 'Faction',
        1786: 'System',
        1787: 'Constellation',
        1788: 'Region',
        1789: 'Station',
        1790: 'Structure',
        1791: 'Character',
        1792: 'Corporation',
        1793: 'Alliance',
        1794: 'Faction',
        1795: 'System',
        1796: 'Constellation',
        1797: 'Region',
        1798: 'Station',
        1799: 'Structure',
        1800: 'Character',
        1801: 'Corporation',
        1802: 'Alliance',
        1803: 'Faction',
        1804: 'System',
        1805: 'Constellation',
        1806: 'Region',
        1807: 'Station',
        1808: 'Structure',
        1809: 'Character',
        1810: 'Corporation',
        1811: 'Alliance',
        1812: 'Faction',
        1813: 'System',
        1814: 'Constellation',
        1815: 'Region',
        1816: 'Station',
        1817: 'Structure',
        1818: 'Character',
        1819: 'Corporation',
        1820: 'Alliance',
        1813: 'Faction',
        1822: 'System',
        1823: 'Constellation',
        1824: 'Region',
        1825: 'Station',
        1826: 'Structure',
        1827: 'Character',
        1828: 'Corporation',
        1829: 'Alliance',
        1830: 'Faction',
        1831: 'System',
        1832: 'Constellation',
        1833: 'Region',
        1834: 'Station',
        1835: 'Structure',
        1836: 'Character',
        1837: 'Corporation',
        1838: 'Alliance',
        1839: 'Faction',
        1840: 'System',
        1841: 'Constellation',
        1842: 'Region',
        1843: 'Station',
        1844: 'Structure',
        1845: 'Character',
        1846: 'Corporation',
        1847: 'Alliance',
        1848: 'Faction',
        1849: 'System',
        1850: 'Constellation',
        1851: 'Region',
        1852: 'Station',
        1853: 'Structure',
        1854: 'Character',
        1855: 'Corporation',
        1856: 'Alliance',
        1857: 'Faction',
        1858: 'System',
        1859: 'Constellation',
        1860: 'Region',
        1861: 'Station',
        1862: 'Structure',
        1863: 'Character',
        1864: 'Corporation',
        1865: 'Alliance',
        1866: 'Faction',
        1867: 'System',
        1868: 'Constellation',
        1869: 'Region',
        1870: 'Station',
        1871: 'Structure',
        1872: 'Character',
        1873: 'Corporation',
        1874: 'Alliance',
        1875: 'Faction',
        1876: 'System',
        1877: 'Constellation',
        1878: 'Region',
        1879: 'Station',
        1880: 'Structure',
        1881: 'Character',
        1882: 'Corporation',
        1883: 'Alliance',
        1884: 'Faction',
        1885: 'System',
        1886: 'Constellation',
        1887: 'Region',
        1888: 'Station',
        1889: 'Structure',
        1890: 'Character',
        1891: 'Corporation',
        1892: 'Alliance',
        1893: 'Faction',
        1894: 'System',
        1895: 'Constellation',
        1896: 'Region',
        1897: 'Station',
        1898: 'Structure',
        1899: 'Character',
        1900: 'Corporation',
        1901: 'Alliance',
        1902: 'Faction',
        1903: 'System',
        1904: 'Constellation',
        1905: 'Region',
        1906: 'Station',
        1907: 'Structure',
        1908: 'Character',
        1909: 'Corporation',
        1910: 'Alliance',
        1911: 'Faction',
        1912: 'System',
        1913: 'Constellation',
        1914: 'Region',
        1915: 'Station',
        1916: 'Structure',
        1917: 'Character',
        1918: 'Corporation',
        1919: 'Alliance',
        1920: 'Faction',
        1921: 'System',
        1922: 'Constellation',
        1923: 'Region',
        1924: 'Station',
        1925: 'Structure',
        1926: 'Character',
        1927: 'Corporation',
        1928: 'Alliance',
        1929: 'Faction',
        1930: 'System',
        1931: 'Constellation',
        1932: 'Region',
        1933: 'Station',
        1934: 'Structure',
        1935: 'Character',
        1936: 'Corporation',
        1937: 'Alliance',
        1938: 'Faction',
        1939: 'System',
        1940: 'Constellation',
        1941: 'Region',
        1942: 'Station',
        1943: 'Structure',
        1944: 'Character',
        1945: 'Corporation',
        1946: 'Alliance',
        1947: 'Faction',
        1948: 'System',
        1949: 'Constellation',
        1950: 'Region',
        1951: 'Station',
        1952: 'Structure',
        1953: 'Character',
        1954: 'Corporation',
        1955: 'Alliance',
        1956: 'Faction',
        1957: 'System',
        1958: 'Constellation',
        1959: 'Region',
        1960: 'Station',
        1961: 'Structure',
        1962: 'Character',
        1963: 'Corporation',
        1964: 'Alliance',
        1965: 'Faction',
        1966: 'System',
        1967: 'Constellation',
        1968: 'Region',
        1969: 'Station',
        1970: 'Structure',
        1971: 'Character',
        1972: 'Corporation',
        1973: 'Alliance',
        1974: 'Faction',
        1975: 'System',
        1976: 'Constellation',
        1977: 'Region',
        1978: 'Station',
        1979: 'Structure',
        1980: 'Character',
        1981: 'Corporation',
        1982: 'Alliance',
        1983: 'Faction',
        1984: 'System',
        1985: 'Constellation',
        1986: 'Region',
        1987: 'Station',
        1988: 'Structure',
        1989: 'Character',
        1990: 'Corporation',
        1991: 'Alliance',
        1992: 'Faction',
        1993: 'System',
        1994: 'Constellation',
        1995: 'Region',
        1996: 'Station',
        1997: 'Structure',
        1998: 'Character',
        1999: 'Corporation',
        2000: 'Alliance',
        2001: 'Faction',
        2002: 'System',
        2003: 'Constellation',
        2004: 'Region',
        2005: 'Station',
        2006: 'Structure',
        2007: 'Character',
        2008: 'Corporation',
        2009: 'Alliance',
        2010: 'Faction',
        2011: 'System',
        2012: 'Constellation',
        2013: 'Region',
        2014: 'Station',
        2015: 'Structure',
        2016: 'Character',
        2017: 'Corporation',
        2018: 'Alliance',
        2019: 'Faction',
        2020: 'System',
        2021: 'Constellation',
        2022: 'Region',
        2023: 'Station',
        2024: 'Structure',
        2025: 'Character',
        2026: 'Corporation',
        2027: 'Alliance',
        2028: 'Faction',
        2029: 'System',
        2030: 'Constellation',
        2031: 'Region',
        2032: 'Station',
        2033: 'Structure',
        2034: 'Character',
        2035: 'Corporation',
        2036: 'Alliance',
        2037: 'Faction',
        2038: 'System',
        2039: 'Constellation',
        2040: 'Region',
        2041: 'Station',
        2042: 'Structure',
        2043: 'Character',
        2044: 'Corporation',
        2045: 'Alliance',
        2046: 'Faction',
        2047: 'System',
        2048: 'Constellation',
        2049: 'Region',
        2050: 'Station',
        2051: 'Structure',
        2052: 'Character',
        2053: 'Corporation',
        2054: 'Alliance',
        2055: 'Faction',
        2056: 'System',
        2057: 'Constellation',
        2058: 'Region',
        2059: 'Station',
        2060: 'Structure',
        2061: 'Character',
        2062: 'Corporation',
        2063: 'Alliance',
        2064: 'Faction',
        2065: 'System',
        2066: 'Constellation',
        2067: 'Region',
        2068: 'Station',
        2069: 'Structure',
        2070: 'Character',
        2071: 'Corporation',
        2072: 'Alliance',
        2073: 'Faction',
        2074: 'System',
        2075: 'Constellation',
        2076: 'Region',
        2077: 'Station',
        2078: 'Structure',
        2079: 'Character',
        2080: 'Corporation',
        2081: 'Alliance',
        2082: 'Faction',
        2083: 'System',
        2084: 'Constellation',
        2085: 'Region',
        2086: 'Station',
        2087: 'Structure',
        2088: 'Character',
        2089: 'Corporation',
        2090: 'Alliance',
        2091: 'Faction',
        2092: 'System',
        2093: 'Constellation',
        2094: 'Region',
        2095: 'Station',
        2096: 'Structure',
        2097: 'Character',
        2098: 'Corporation',
        2099: 'Alliance',
        2100: 'Faction',
        2101: 'System',
        2102: 'Constellation',
        2103: 'Region',
        2104: 'Station',
        2105: 'Structure',
        2106: 'Character',
        2107: 'Corporation',
        2108: 'Alliance',
        2109: 'Faction',
        2110: 'System',
        2111: 'Constellation',
        2112: 'Region',
        2113: 'Station',
        2114: 'Structure',
        2115: 'Character',
        2116: 'Corporation',
        2117: 'Alliance',
        2118: 'Faction',
        2119: 'System',
        2120: 'Constellation',
        2121: 'Region',
        2122: 'Station',
        2123: 'Structure',
        2124: 'Character',
        2125: 'Corporation',
        2126: 'Alliance',
        2127: 'Faction',
        2128: 'System',
        2129: 'Constellation',
        2130: 'Region',
        2131: 'Station',
        2132: 'Structure',
        2133: 'Character',
        2134: 'Corporation',
        2135: 'Alliance',
        2136: 'Faction',
        2137: 'System',
        2138: 'Constellation',
        2139: 'Region',
        2140: 'Station',
        2141: 'Structure',
        2142: 'Character',
        2143: 'Corporation',
        2144: 'Alliance',
        2145: 'Faction',
        2146: 'System',
        2147: 'Constellation',
        2148: 'Region',
        2149: 'Station',
        2150: 'Structure',
        2151: 'Character',
        2152: 'Corporation',
        2153: 'Alliance',
        2154: 'Faction',
        2155: 'System',
        2156: 'Constellation',
        2157: 'Region',
        2158: 'Station',
        2159: 'Structure',
        2160: 'Character',
        2161: 'Corporation',
        2162: 'Alliance',
        2163: 'Faction',
        2164: 'System',
        2165: 'Constellation',
        2166: 'Card',
    }

    for skill in skills:
        # Get category ID from ItemType
        try:
            item_type = ItemType.objects.get(id=skill.skill_id)
            cat_id = item_type.category_id
            cat_name = category_map.get(cat_id, f'Category {cat_id}')
        except ItemType.DoesNotExist:
            cat_id = 0
            cat_name = 'Unknown'

        skills_by_category[cat_name].append(skill)

    # Sort categories and skills within each category
    sorted_categories = sorted(skills_by_category.items(), key=lambda x: x[0])

    for cat_name, skill_list in skills_by_category.items():
        skill_list.sort(key=lambda s: s.skill_name)

    return render(request, 'core/character_skills.html', {
        'character': character,
        'skills_by_category': dict(sorted_categories),
        'total_skills': skills.count(),
    })


@login_required
@require_http_methods(['POST'])
def sync_character(request: HttpRequest, character_id: int) -> HttpResponse:
    """Trigger a manual sync of character data from ESI."""
    from core.models import Character
    from django_q.tasks import async_task

    try:
        character = Character.objects.get(id=character_id, user=request.user)
    except Character.DoesNotExist:
        return render(request, 'core/error.html', {
            'message': 'Character not found',
        }, status=404)

    # Queue the sync task
    async_task('core.services.sync_character_data', character)

    return redirect('character_detail', character_id=character_id)
