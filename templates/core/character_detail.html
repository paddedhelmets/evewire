{% extends "base.html" %}
{% load evewire %}

{% block title %}{{ character.name }} - evewire{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h1>{{ character.name }}</h1>
    <div style="display: flex; gap: 0.5rem;">
        {% if character.last_sync_status == 'needs_reauth' %}
            <form method="get" action="{% url 'core:reauthenticate_character' character.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn" style="background: var(--color-primary); color: white;">Re-authenticate</button>
            </form>
        {% else %}
            <form method="post" action="{% url 'core:sync_character' character.id %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn">Sync All Data</button>
            </form>
        {% endif %}
    </div>
</div>

{% if character.last_sync_status == 'needs_reauth' %}
<div class="card" style="margin-bottom: 1rem; border-left: 4px solid var(--color-primary); background: #fff3cd;">
    <h3>⚠️ Authentication Required</h3>
    <p>This character needs to be re-authenticated through EVE SSO. This usually happens when:</p>
    <ul>
        <li>Your access token has expired</li>
        <li>The character was linked with insufficient scopes</li>
        <li>The refresh token has become invalid</li>
    </ul>
    <p><strong>Click the "Re-authenticate" button above to fix this.</strong></p>
    {% if character.last_sync_error %}
        <p style="color: var(--alert-error-text); font-size: 0.9rem;">Error: {{ character.last_sync_error }}</p>
    {% endif %}
</div>
{% endif %}

<div class="card">
    <h2>Character Information</h2>
    <p><strong>Character ID:</strong> {{ character.id }}</p>
    <p><strong>Corporation:</strong> {{ character.user.corporation_name|default:"N/A" }}</p>
    <p><strong>Alliance:</strong> {{ character.user.alliance_name|default:"None" }}</p>
</div>

<div class="card">
    <h2>Attributes</h2>
    {% if character.attributes %}
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid #ddd;">
                    <th style="padding: 0.5rem; text-align: left;">Attribute</th>
                    <th style="padding: 0.5rem; text-align: center;">Value</th>
                    <th style="padding: 0.5rem; text-align: left;">Primary For</th>
                </tr>
            </thead>
            <tbody>
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 0.5rem;"><strong>Intelligence</strong></td>
                    <td style="padding: 0.5rem; text-align: center; font-size: 1.2rem;">{{ character.attributes.intelligence }}</td>
                    <td style="padding: 0.5rem; color: #666;">Electronics, Engineering, Science, Mechanics</td>
                </tr>
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 0.5rem;"><strong>Perception</strong></td>
                    <td style="padding: 0.5rem; text-align: center; font-size: 1.2rem;">{{ character.attributes.perception }}</td>
                    <td style="padding: 0.5rem; color: #666;">Spaceship Command, Gunnery, Missiles</td>
                </tr>
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 0.5rem;"><strong>Charisma</strong></td>
                    <td style="padding: 0.5rem; text-align: center; font-size: 1.2rem;">{{ character.attributes.charisma }}</td>
                    <td style="padding: 0.5rem; color: #666;">Trade, Social, Leadership</td>
                </tr>
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 0.5rem;"><strong>Willpower</strong></td>
                    <td style="padding: 0.5rem; text-align: center; font-size: 1.2rem;">{{ character.attributes.willpower }}</td>
                    <td style="padding: 0.5rem; color: #666;">Command, Advanced Industry</td>
                </tr>
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 0.5rem;"><strong>Memory</strong></td>
                    <td style="padding: 0.5rem; text-align: center; font-size: 1.2rem;">{{ character.attributes.memory }}</td>
                    <td style="padding: 0.5rem; color: #666;">Industry, Drones, Learning</td>
                </tr>
            </tbody>
        </table>
        <p style="color: #666; margin-top: 0.5rem;">Last updated: {{ character.attributes.synced_at|date:"Y-m-d H:i:s" }}</p>
    {% else %}
        <p>No attribute data. <a href="{% url 'core:sync_character' character.id %}" class="btn">Sync Now</a></p>
    {% endif %}
</div>

<div class="card">
    <h2>Implants</h2>
    {% with implants=character.implants.all %}
        {% if implants %}
            <p><strong>{{ implants.count }}</strong> implant{{ implants.count|pluralize }} installed</p>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #ddd;">
                        <th style="padding: 0.5rem; text-align: left;">Implant</th>
                        <th style="padding: 0.5rem; text-align: left;">Slot</th>
                    </tr>
                </thead>
                <tbody>
                    {% for implant in implants %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 0.5rem;">{{ implant.type_name }}</td>
                        <td style="padding: 0.5rem;">{{ implant.slot|default:"Unknown" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: #666;">No implants installed.</p>
        {% endif %}
    {% endwith %}
</div>

<div class="card">
    <h2>Wallet</h2>
    {% if character.wallet_balance is not None %}
        <p style="font-size: 1.5rem; font-weight: bold;">
            {{ character.wallet_balance|floatformat:2 }} ISK
        </p>
        <p style="color: #666;">Last updated: {{ character.wallet_synced_at|date:"Y-m-d H:i:s" }}</p>
        <div style="margin-top: 1rem;">
            <a href="{% url 'core:character_wallet_journal' character.id %}" class="btn">Journal</a>
            <a href="{% url 'core:character_wallet_transactions' character.id %}" class="btn" style="margin-left: 0.5rem;">Transactions</a>
            <a href="{% url 'core:character_wallet_balance' character.id %}" class="btn" style="margin-left: 0.5rem;">Balance History</a>
            <a href="{% url 'core:character_wallet_summary' character.id %}" class="btn" style="margin-left: 0.5rem;">Summary</a>
        </div>
    {% else %}
        <p>No wallet data.</p>
    {% endif %}
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
        <h2>Skills</h2>
        <a href="{% url 'core:skills_list' %}" style="font-size: 0.9rem;">View All Skills →</a>
    </div>
    {% if character.total_sp is not None %}
        <p><strong>Total SP:</strong> {{ character.total_sp }}</p>
        <p style="color: #666; margin-bottom: 1rem;">Last updated: {{ character.skills_synced_at|date:"Y-m-d H:i:s" }}</p>

        <h3>Top Skills (by Level)</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid #ddd;">
                    <th style="padding: 0.5rem; text-align: left;">Skill</th>
                    <th style="padding: 0.5rem; text-align: center;">Level</th>
                    <th style="padding: 0.5rem; text-align: right;">SP</th>
                </tr>
            </thead>
            <tbody>
                {% for skill in character.skills.all|dictsort:"skill_level"|dictsortreversed:"skill_level"|slice:":20" %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 0.5rem;">{{ skill.skill_name }}</td>
                    <td style="padding: 0.5rem; text-align: center;">
                        <span style="color: {% if skill.skill_level == 5 %}#c00{% elif skill.skill_level == 4 %}#c60{% else %}#666{% endif %}; font-weight: bold;">
                            {{ skill.skill_level }}
                        </span>
                    </td>
                    <td style="padding: 0.5rem; text-align: right;">{{ skill.skillpoints_in_skill }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" style="padding: 0.5rem; color: #666;">No skills found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No skills data.</p>
    {% endif %}
</div>

<div class="card" id="queue">
    <h2>Skill Queue</h2>
    {% with queue=character.skill_queue.all %}
        {% if queue %}
            <p><strong>{{ queue.count }}</strong> skill{{ queue.count|pluralize }} in queue</p>
            {% for item in queue %}
                <div style="border: 1px solid #ddd; border-radius: 4px; padding: 1rem; margin-bottom: 0.5rem; {% if item.is_completed %}opacity: 0.6;{% endif %}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div>
                            <strong>{{ item.skill_name }}</strong> to Level {{ item.finish_level }}
                            {% if item.is_completed %}<span style="color: #080;">✓ Completed</span>{% endif %}
                        </div>
                        <div style="text-align: right; font-size: 0.9rem; color: #666;">
                            Finishes: {{ item.finish_date|date:"Y-m-d H:i" }}
                        </div>
                    </div>
                    <div style="background: #eee; height: 20px; border-radius: 4px; overflow: hidden;">
                        <div style="background: {% if item.is_completed %}#080{% else %}#0066cc{% endif %}; height: 100%; width: {{ item.progress_percent }}%;"></div>
                    </div>
                    <p style="font-size: 0.9rem; color: #666;">{{ item.progress_percent|floatformat:1 }}% complete ({{ item.level_start_sp }} → {{ item.level_end_sp }} SP)</p>
                </div>
            {% endfor %}
        {% else %}
            <p style="color: #666;">No skills in queue.</p>
        {% endif %}
    {% endwith %}
</div>

<div class="card" id="orders">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
        <h2>Market Orders</h2>
        <a href="{% url 'core:character_market_orders' character.id %}" style="font-size: 0.9rem;">View All Orders →</a>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
        <div style="border: 1px solid #ddd; border-radius: 4px; padding: 0.75rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                <span style="font-size: 0.9rem; color: #666;">Buy Orders</span>
                <span style="font-weight: bold; color: #080;">{{ character.market_orders.all|dictsort:"is_buy_order"|reverse|dictsortreversed:"is_buy_order"|slice:":100"|selectattr:"is_open"|list|length }}</span>
            </div>
        </div>
        <div style="border: 1px solid #ddd; border-radius: 4px; padding: 0.75rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                <span style="font-size: 0.9rem; color: #666;">Sell Orders</span>
                <span style="font-weight: bold; color: #c00;">{{ character.market_orders.all|dictsort:"is_buy_order"|slice:":100"|selectattr:"is_open"|list|length }}</span>
            </div>
        </div>
        <div style="border: 1px solid #ddd; border-radius: 4px; padding: 0.75rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                <span style="font-size: 0.9rem; color: #666;">Slots</span>
                <span style="font-weight: bold;">{{ character.active_market_orders }}/{{ character.market_order_slots }}</span>
            </div>
            <div style="background: #eee; height: 8px; border-radius: 4px; overflow: hidden;">
                <div style="background: {% if character.market_order_utilization >= 100 %}#c00{% elif character.is_market_orders_nearly_full %}#ffc107{% else %}#080{% endif %}; height: 100%; width: {{ character.market_order_utilization }}%;"></div>
            </div>
        </div>
    </div>
    {% with orders=character.market_orders.all|dictsort:"is_buy_order"|slice:":10" %}
        {% if orders %}
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #ddd;">
                        <th style="padding: 0.5rem; text-align: left;">Type</th>
                        <th style="padding: 0.5rem; text-align: left;">Item</th>
                        <th style="padding: 0.5rem; text-align: right;">Price</th>
                        <th style="padding: 0.5rem; text-align: right;">Remaining</th>
                        <th style="padding: 0.5rem; text-align: right;">Total</th>
                        <th style="padding: 0.5rem; text-align: left;">Station</th>
                        <th style="padding: 0.5rem; text-align: left;">Expires</th>
                        <th style="padding: 0.5rem; text-align: left;">State</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr style="border-bottom: 1px solid #eee; {% if not order.is_open %}opacity: 0.6;{% endif %}">
                        <td style="padding: 0.5rem;">
                            <span style="color: {% if order.is_buy_order %}#080{% else %}#c00{% endif %}; font-weight: bold;">
                                {% if order.is_buy_order %}BUY{% else %}SELL{% endif %}
                            </span>
                        </td>
                        <td style="padding: 0.5rem;">{{ order.type_name }}</td>
                        <td style="padding: 0.5rem; text-align: right;">{{ order.price|floatformat:2 }}</td>
                        <td style="padding: 0.5rem; text-align: right;">{{ order.volume_remain }}/{{ order.volume_total }}</td>
                        <td style="padding: 0.5rem; text-align: right;">{{ order.price|multiply:order.volume_remain|floatformat:2 }}</td>
                        <td style="padding: 0.5rem; font-size: 0.9rem;">{{ order.station_id }}</td>
                        <td style="padding: 0.5rem;">{{ order.expires_at|date:"M d H:i" }}</td>
                        <td style="padding: 0.5rem;">
                            <span style="font-size: 0.9rem; padding: 2px 6px; border-radius: 3px; background: {% if order.state == 'open' %}#e6f7e6{% else %}#f7e6e6{% endif %}; color: {% if order.state == 'open' %}#080{% else %}#c00{% endif %};">
                                {{ order.state|title }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if character.market_orders.all.count > 10 %}
            <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                Showing 10 of {{ character.market_orders.all.count }} orders. <a href="{% url 'core:character_market_orders' character.id %}">View all →</a>
            </p>
            {% endif %}
        {% else %}
            <p style="color: #666;">No market orders.</p>
        {% endif %}
    {% endwith %}
</div>

<div class="card" id="contracts">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
        <h2>Contracts</h2>
        <a href="{% url 'core:character_contracts' character.id %}" style="font-size: 0.9rem;">View All Contracts →</a>
    </div>
    {% with contracts=character.contracts.all|dictsort:"date_issued"|slice:":10" %}
        {% if contracts %}
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                <div style="border: 1px solid #ddd; border-radius: 4px; padding: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                        <span style="font-size: 0.9rem; color: #666;">Outstanding</span>
                        <span style="font-weight: bold; color: #0066cc;">{{ character.contracts.all|selectattr:"status"|equal:"outstanding"|list|length }}</span>
                    </div>
                </div>
                <div style="border: 1px solid #ddd; border-radius: 4px; padding: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                        <span style="font-size: 0.9rem; color: #666;">In Progress</span>
                        <span style="font-weight: bold; color: #080;">{{ character.contracts.all|selectattr:"status"|equal:"in_progress"|list|length }}</span>
                    </div>
                </div>
                <div style="border: 1px solid #ddd; border-radius: 4px; padding: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                        <span style="font-size: 0.9rem; color: #666;">Completed</span>
                        <span style="font-weight: bold; color: #666;">{{ character.contracts.all|selectattr:"is_completed"|list|length }}</span>
                    </div>
                </div>
            </div>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #ddd;">
                        <th style="padding: 0.5rem; text-align: left;">Type</th>
                        <th style="padding: 0.5rem; text-align: left;">Title</th>
                        <th style="padding: 0.5rem; text-align: left;">Status</th>
                        <th style="padding: 0.5rem; text-align: right;">Value</th>
                        <th style="padding: 0.5rem; text-align: left;">Expires</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contract in contracts %}
                    <tr style="border-bottom: 1px solid #eee; {% if not contract.is_active %}opacity: 0.6;{% endif %}">
                        <td style="padding: 0.5rem;">{{ contract.type_name }}</td>
                        <td style="padding: 0.5rem;">
                            <a href="{% url 'core:contract_detail' contract.contract_id %}">
                                {{ contract.title|default:contract.type_name }}
                            </a>
                        </td>
                        <td style="padding: 0.5rem;">
                            <span style="font-size: 0.9rem; padding: 2px 6px; border-radius: 3px; background: {% if contract.is_active %}#e6f7e6{% elif contract.is_completed %}#d4edda{% else %}#f7e6e6{% endif %}; color: {% if contract.is_active %}#080{% elif contract.is_completed %}#155724{% else %}#c00{% endif %};">
                                {{ contract.status_name }}
                            </span>
                            {% if contract.expires_soon %}
                                <span style="color: #c00; margin-left: 0.25rem;">&excl;</span>
                            {% endif %}
                        </td>
                        <td style="padding: 0.5rem; text-align: right;">{{ contract.total_value|floatformat:2 }}</td>
                        <td style="padding: 0.5rem;">{{ contract.date_expired|date:"M d H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if character.contracts.all.count > 10 %}
            <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                Showing 10 of {{ character.contracts.all.count }} contracts. <a href="{% url 'core:character_contracts' character.id %}">View all →</a>
            </p>
            {% endif %}
        {% else %}
            <p style="color: #666;">No contracts.</p>
        {% endif %}
    {% endwith %}
</div>

<div class="card" id="industry-slots">
    <h2>Industry Slots</h2>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <!-- Manufacturing Slots -->
        <div style="border: 1px solid #ddd; border-radius: 4px; padding: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <h3 style="margin: 0;">Manufacturing</h3>
                {% if not character.has_available_manufacturing_slot %}
                    <span style="padding: 4px 8px; border-radius: 3px; background: #f7e6e6; color: #c00; font-size: 0.85rem;">Full</span>
                {% elif character.is_manufacturing_nearly_full %}
                    <span style="padding: 4px 8px; border-radius: 3px; background: #fff3cd; color: #856404; font-size: 0.85rem;">Nearly Full</span>
                {% else %}
                    <span style="padding: 4px 8px; border-radius: 3px; background: #e6f7e6; color: #080; font-size: 0.85rem;">Available</span>
                {% endif %}
            </div>
            <p style="font-size: 1.5rem; font-weight: bold; margin: 0.5rem 0;">
                {{ character.active_manufacturing_jobs }} / {{ character.manufacturing_slots }}
            </p>
            <div style="background: #eee; height: 20px; border-radius: 4px; overflow: hidden;">
                <div style="background: {% if character.manufacturing_utilization >= 100 %}#c00{% elif character.is_manufacturing_nearly_full %}#ffc107{% else %}#080{% endif %}; height: 100%; width: {{ character.manufacturing_utilization }}%;"></div>
            </div>
            <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">{{ character.manufacturing_utilization|floatformat:0 }}% utilized</p>
        </div>

        <!-- Research Slots -->
        <div style="border: 1px solid #ddd; border-radius: 4px; padding: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <h3 style="margin: 0;">Research & Labs</h3>
                {% if not character.has_available_research_slot %}
                    <span style="padding: 4px 8px; border-radius: 3px; background: #f7e6e6; color: #c00; font-size: 0.85rem;">Full</span>
                {% elif character.is_research_nearly_full %}
                    <span style="padding: 4px 8px; border-radius: 3px; background: #fff3cd; color: #856404; font-size: 0.85rem;">Nearly Full</span>
                {% else %}
                    <span style="padding: 4px 8px; border-radius: 3px; background: #e6f7e6; color: #080; font-size: 0.85rem;">Available</span>
                {% endif %}
            </div>
            <p style="font-size: 1.5rem; font-weight: bold; margin: 0.5rem 0;">
                {{ character.active_research_jobs }} / {{ character.research_slots }}
            </p>
            <div style="background: #eee; height: 20px; border-radius: 4px; overflow: hidden;">
                <div style="background: {% if character.research_utilization >= 100 %}#c00{% elif character.is_research_nearly_full %}#ffc107{% else %}#080{% endif %}; height: 100%; width: {{ character.research_utilization }}%;"></div>
            </div>
            <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">{{ character.research_utilization|floatformat:0 }}% utilized</p>
        </div>
    </div>
    <p style="font-size: 0.85rem; color: #666; margin-top: 1rem;">
        Slot limits based on Industry (manufacturing) and Advanced Industry (research) skill levels.
    </p>
</div>

<div class="card" id="industry-jobs">
    <h2>Industry Jobs</h2>
    {% with active_jobs=character.industry_jobs.all|dictsort:"end_date" %}
        {% if active_jobs %}
            <p><strong>{{ active_jobs.count }}</strong> job{{ active_jobs.count|pluralize }}</p>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #ddd;">
                        <th style="padding: 0.5rem; text-align: left;">Activity</th>
                        <th style="padding: 0.5rem; text-align: left;">Blueprint</th>
                        <th style="padding: 0.5rem; text-align: left;">Product</th>
                        <th style="padding: 0.5rem; text-align: left;">Location</th>
                        <th style="padding: 0.5rem; text-align: left;">Progress</th>
                        <th style="padding: 0.5rem; text-align: right;">Time Remaining</th>
                        <th style="padding: 0.5rem; text-align: left;">End Date</th>
                        <th style="padding: 0.5rem; text-align: left;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in active_jobs %}
                    <tr style="border-bottom: 1px solid #eee; {% if not job.is_active %}opacity: 0.6;{% endif %}">
                        <td style="padding: 0.5rem;">{{ job.activity_name }}</td>
                        <td style="padding: 0.5rem;">{{ job.blueprint_type_name }}</td>
                        <td style="padding: 0.5rem;">{{ job.product_name }}</td>
                        <td style="padding: 0.5rem; font-size: 0.9rem;">{{ job.solar_system_id }}</td>
                        <td style="padding: 0.5rem; min-width: 150px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="background: #eee; height: 20px; border-radius: 4px; overflow: hidden; flex: 1;">
                                    <div style="background: {% if job.is_completed %}#080{% elif job.is_active %}#0066cc{% else %}#666{% endif %}; height: 100%; width: {{ job.progress_percent }}%;"></div>
                                </div>
                                <span style="font-size: 0.85rem; color: #666; min-width: 45px; text-align: right;">{{ job.progress_percent|floatformat:0 }}%</span>
                            </div>
                            {% if job.is_expiring_soon %}
                                <span style="display: inline-block; margin-top: 0.25rem; padding: 2px 6px; border-radius: 3px; background: #fff3cd; color: #856404; font-size: 0.75rem;">Expiring Soon</span>
                            {% endif %}
                        </td>
                        <td style="padding: 0.5rem; text-align: right;">{{ job.time_remaining|format_timedelta }}</td>
                        <td style="padding: 0.5rem;">{{ job.end_date|date:"M d H:i" }}</td>
                        <td style="padding: 0.5rem;">
                            <span style="font-size: 0.9rem; padding: 2px 6px; border-radius: 3px; background: {% if job.status == 1 %}#e6f7e6{% elif job.status == 104 %}#d4edda{% else %}#f7e6e6{% endif %}; color: {% if job.status == 1 %}#080{% elif job.status == 104 %}#155724{% else %}#c00{% endif %};">
                                {{ job.status_name }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: #666;">No industry jobs.</p>
        {% endif %}
    {% endwith %}
</div>

<div class="card" id="assets">
    <h2>Assets</h2>
    {% if root_assets %}
        <p><strong>{{ root_assets.count }}</strong> top-level asset{{ root_assets.count|pluralize }}</p>
        <details>
            <summary style="cursor: pointer; padding: 0.5rem; background: #f5f5f5; border-radius: 4px; margin-bottom: 1rem;">Show all assets</summary>
            <ul style="margin-top: 1rem;">
                {% for asset in root_assets %}
                <li style="padding: 0.5rem; border-bottom: 1px solid #eee;">
                    <strong>{{ asset.type_name }}</strong> x{{ asset.quantity }}
                    <span style="color: #666; font-size: 0.9rem;">@ {{ asset.location_name }}</span>
                    {% if asset.children.exists %}
                        <details style="margin-left: 1rem;">
                            <summary style="cursor: pointer; font-size: 0.9rem; color: #666;">Contents ({{ asset.children.count }} item{{ asset.children.count|pluralize }})</summary>
                            <ul style="margin-left: 1rem;">
                                {% for child in asset.get_descendants %}
                                <li style="padding: 0.25rem 0; font-size: 0.9rem;">
                                    {{ child.type_name }} x{{ child.quantity }}
                                </li>
                                {% endfor %}
                            </ul>
                        </details>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </details>
    {% else %}
        <p style="color: #666;">No assets found.</p>
    {% endif %}
</div>
{% endblock %}
